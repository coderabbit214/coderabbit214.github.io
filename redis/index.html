<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Redis - 第二大脑</title><meta name="Description" content="第二大脑"><meta property="og:title" content="Redis" />
<meta property="og:description" content="Redis 一.基本指令 1 2 3 4 5 6 7 8 9 key * //查询当前数据库所有的键 exists &lt;key&gt; //判断某个键是否存在 1：true 2：false type &lt;key&gt; //查看键的类型 del &lt;key&gt; /" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/redis/" /><meta property="og:image" content="http://example.org/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-06-01T11:56:36+08:00" />
<meta property="article:modified_time" content="2020-06-01T11:56:36+08:00" /><meta property="og:site_name" content="第二大脑" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://example.org/logo.png"/>

<meta name="twitter:title" content="Redis"/>
<meta name="twitter:description" content="Redis 一.基本指令 1 2 3 4 5 6 7 8 9 key * //查询当前数据库所有的键 exists &lt;key&gt; //判断某个键是否存在 1：true 2：false type &lt;key&gt; //查看键的类型 del &lt;key&gt; /"/>
<meta name="application-name" content="第二大脑">
<meta name="apple-mobile-web-app-title" content="第二大脑"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/logo.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://example.org/redis/" /><link rel="prev" href="http://example.org/git/" /><link rel="next" href="http://example.org/guli-1-mybatis-plus/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Redis",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/example.org\/redis\/"
        },"genre": "posts","keywords": "非关系型数据库","wordcount":  6956 ,
        "url": "http:\/\/example.org\/redis\/","datePublished": "2020-06-01T11:56:36+08:00","dateModified": "2020-06-01T11:56:36+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "coderabbit"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="第二大脑"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/logo.png"
        data-srcset="/logo.png, /logo.png 1.5x, /logo.png 2x"
        data-sizes="auto"
        alt="/logo.png"
        title="/logo.png" />第二大脑</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="第二大脑"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/logo.png"
        data-srcset="/logo.png, /logo.png 1.5x, /logo.png 2x"
        data-sizes="auto"
        alt="/logo.png"
        title="/logo.png" />第二大脑</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Redis</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/coderabbit214" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>coderabbit</a></span>&nbsp;<span class="post-category">included in <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>数据库</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2020-06-01">2020-06-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;6956 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;14 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#一基本指令">一.基本指令</a></li>
    <li><a href="#二redis的五大数据类型">二.Redis的五大数据类型</a>
      <ul>
        <li><a href="#1string使用最多">1.String(使用最多)</a></li>
        <li><a href="#2list">2.List</a></li>
        <li><a href="#3set">3.Set</a></li>
        <li><a href="#4hash">4.Hash</a></li>
        <li><a href="#5zset">5.ZSet</a>
          <ul>
            <li><a href="#使用zset实现文章访问量的排行">使用zset实现文章访问量的排行</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#三redis的相关配置">三.Redis的相关配置</a></li>
    <li><a href="#四连接javassm">四.连接java(SSM)</a>
      <ul>
        <li><a href="#手机短信验证例子">手机短信验证例子</a></li>
      </ul>
    </li>
    <li><a href="#五redis事务">五.Redis事务</a>
      <ul>
        <li>
          <ul>
            <li><a href="#监视">监视</a></li>
            <li><a href="#三特性">三特性</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#六持久化">六.持久化</a>
      <ul>
        <li><a href="#rdb">RDB</a>
          <ul>
            <li><a href="#配置文件">配置文件</a></li>
            <li><a href="#触发条件">触发条件</a></li>
            <li><a href="#如何恢复">如何恢复</a></li>
          </ul>
        </li>
        <li><a href="#aof">AOF</a>
          <ul>
            <li><a href="#如何恢复-1">如何恢复</a>
              <ul>
                <li><a href="#正常恢复">正常恢复</a></li>
                <li><a href="#异常恢复">异常恢复</a></li>
              </ul>
            </li>
            <li><a href="#优势">优势</a></li>
            <li><a href="#劣势">劣势</a></li>
          </ul>
        </li>
        <li><a href="#总结">总结</a></li>
      </ul>
    </li>
    <li><a href="#七复制masterslaver">七.复制(master/slaver)</a>
      <ul>
        <li><a href="#配置配置从服务器不配置主服务器">配置(配置从服务器，不配置主服务器)</a></li>
        <li><a href="#薪火相传">薪火相传</a></li>
        <li><a href="#哨兵模式">哨兵模式</a></li>
      </ul>
    </li>
    <li><a href="#八redis集群以后再学">八.Redis集群（以后再学）</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="redis">Redis</h1>
<h2 id="一基本指令">一.基本指令</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">key * //查询当前数据库所有的键
</span></span><span class="line"><span class="cl">exists &lt;key&gt; //判断某个键是否存在 1：true 2：false
</span></span><span class="line"><span class="cl">type &lt;key&gt; //查看键的类型
</span></span><span class="line"><span class="cl">del &lt;key&gt; //删除键
</span></span><span class="line"><span class="cl">expire &lt;key&gt; &lt;seconds&gt; //为键设置过启德的时间 单位为秒
</span></span><span class="line"><span class="cl">ttl &lt;key&gt; //查看还有多长时间过期 “-1”代表永不过期 “-2”代表已过期
</span></span><span class="line"><span class="cl">dbsize //查看当前库的key的数量
</span></span><span class="line"><span class="cl">Flushdb //清空当前库
</span></span><span class="line"><span class="cl">Flushall //通杀全部库
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="二redis的五大数据类型">二.Redis的五大数据类型</h2>
<h3 id="1string使用最多">1.String(使用最多)</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">get &lt;key&gt; //查询对应的键值
</span></span><span class="line"><span class="cl">set &lt;key&gt; &lt;value&gt; //添加键值对
</span></span><span class="line"><span class="cl">append &lt;key&gt; &lt;value&gt; //给给定的key追加值
</span></span><span class="line"><span class="cl">strlen &lt;key&gt; //获取值的长度
</span></span><span class="line"><span class="cl">setnx &lt;key&gt; &lt;value&gt; //只有在key不存在时设置key的值
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">incr &lt;key&gt; //将key存储的数字值+1 只能对数字操作
</span></span><span class="line"><span class="cl">decr &lt;key&gt; //将key存储的数字值-1 只能对数字操作
</span></span><span class="line"><span class="cl">incrby &lt;key&gt; &lt;步长&gt; //将key存储的数字值+步长 只能对数字操作
</span></span><span class="line"><span class="cl">decrby &lt;key&gt; &lt;步长&gt; //将key存储的数字值-步长 只能对数字操作
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mset &lt;key1&gt; &lt;value1&gt; &lt;key2&gt; &lt;value2&gt; ... //同时设置多个键值对
</span></span><span class="line"><span class="cl">mget &lt;key1&gt; &lt;key2&gt; &lt;key3&gt; ... //同时获取多尔衮value
</span></span><span class="line"><span class="cl">msetnx &lt;key1&gt; &lt;value1&gt; &lt;key2&gt; &lt;value2&gt; ... //同时设置多个键值对;当且仅当所有给定的key都不存在时
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">getrange &lt;key&gt; &lt;起始位置&gt; &lt;结束位置&gt; //截取一段值；起始位置从0开始；包前也包后
</span></span><span class="line"><span class="cl">setrange &lt;key&gt; &lt;起始位置&gt; &lt;value&gt; //从起始位置开始赋值覆盖
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">setex &lt;key&gt; &lt;过期时间&gt; &lt;value&gt; //设置键值的同时，设置过期时间
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">getset &lt;key&gt; &lt;value&gt; //以旧换新 设置了新值的同时获得旧值
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2list">2.List</h3>
<blockquote>
<p>单键多值</p>
<p>底层是双向链表 对两端的操作性高，通过索引操作中间节点性能较差</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">lpush/rpush &lt;key&gt; &lt;value1&gt; &lt;value2&gt;... //从左边/右边加入一个或多个值
</span></span><span class="line"><span class="cl">lpop/rpop &lt;key&gt; //从左边/右边取出一个值
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">rpoplpush &lt;key1&gt; &lt;key2&gt; //从key1的右边取出一个放在key2的左边
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">lrange &lt;key&gt; &lt;start&gt; &lt;stop&gt; //按照索引下标获得元素（从左到右）负值从右到左
</span></span><span class="line"><span class="cl">lindex &lt;key&gt; &lt;index&gt; //按照索引下标获得元素（从左到右）
</span></span><span class="line"><span class="cl">llen &lt;key&gt; //获得列表长r度
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">linsert &lt;key&gt; after/before &lt;value&gt; &lt;newvalue&gt; //在value 后/前插入 newvalue 的值 如果有相同的值 只对第一个起作用
</span></span><span class="line"><span class="cl">lrem &lt;key&gt; &lt;n&gt; &lt;value&gt; //删除n个value 正数从左往右删 负数从右往左 0代表删除所有
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="3set">3.Set</h3>
<blockquote>
<p>与list功能类似 但是value不能重复</p>
<p>String类型的无序集合</p>
<p>底层是value为空的hash表</p>
<p>删除查找的复杂度都是O(1)</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sadd &lt;key&gt; &lt;value1&gt; &lt;value2&gt;... //加入一个或多个值
</span></span><span class="line"><span class="cl">smembers &lt;key&gt; //取出该集合的所有值
</span></span><span class="line"><span class="cl">sismember &lt;key&gt; &lt;value&gt; //判断集合&lt;key&gt;是否为含有该&lt;value&gt;值，有返回1，没有返回0
</span></span><span class="line"><span class="cl">scard &lt;key&gt; //返回该集合的元素个数
</span></span><span class="line"><span class="cl">srem &lt;key&gt; &lt;value1&gt; &lt;value2&gt; //删除集合中的某个元素
</span></span><span class="line"><span class="cl">spop &lt;key&gt; //随机从元素中吐出一个值
</span></span><span class="line"><span class="cl">srandmember &lt;key&gt; &lt;n&gt; //随机从元素中吐出N个值,不会删除
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sinter &lt;key1&gt; &lt;key2&gt; //返回两个集合的交集
</span></span><span class="line"><span class="cl">sunion &lt;key1&gt; &lt;key2&gt; //返回两个集合的并集
</span></span><span class="line"><span class="cl">sdiff &lt;key1&gt; &lt;key2&gt; //返回两个集合的差集
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="4hash">4.Hash</h3>
<blockquote>
<p>是键值对集合</p>
<p>适合存储对象</p>
<p>类似java中的 Map&lt;String,String&gt;</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">hset &lt;key&gt; &lt;field&gt; &lt;value&gt; //为指定的key设定field和value
</span></span><span class="line"><span class="cl">hget &lt;key&gt; &lt;field&gt; //取出指定的value
</span></span><span class="line"><span class="cl">hmset &lt;key&gt; &lt;field&gt; &lt;value&gt; &lt;field&gt; &lt;value&gt;... //为指定的key设定一个或多个field和value
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">hexists &lt;key&gt; &lt;field&gt; //在key里面是否存在指定的field
</span></span><span class="line"><span class="cl">hkeys &lt;key&gt; //获取hash表所有key
</span></span><span class="line"><span class="cl">hvals &lt;key&gt; //获取hash表所有值
</span></span><span class="line"><span class="cl">hgetall &lt;key&gt; //获取hash表所有的键值对
</span></span><span class="line"><span class="cl">hincrby &lt;key&gt; &lt;field&gt; &lt;increment&gt; //增加某个field的值,只能是数字
</span></span><span class="line"><span class="cl">hsetnx &lt;key&gt; &lt;field&gt; &lt;value&gt; //当不存在才创建该field
</span></span><span class="line"><span class="cl">hlen &lt;key&gt; //获取hash表中的字段数量
</span></span><span class="line"><span class="cl">hdel &lt;key&gt; &lt;field1&gt; &lt;field2&gt; //删除一个或多个hash表的字段
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="5zset">5.ZSet</h3>
<blockquote>
<p>在Set的基础上加上评分</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">zadd &lt;key&gt; &lt;score1&gt; &lt;value1&gt; //将一个或多个元素及其评分加入;相同元素，不同分数，会将分数更新
</span></span><span class="line"><span class="cl">zrange &lt;key&gt; &lt;start&gt; &lt;stop&gt; [WITHSCORES] // 指定输出索引范围内的成员;[WITHSCORES]可以携带分数
</span></span><span class="line"><span class="cl">zrevrange &lt;key&gt; &lt;start&gt; &lt;stop&gt; //返回有序集中指定区间内的成员，通过索引，分数从高到底
</span></span><span class="line"><span class="cl">zrangebyscore &lt;key&gt; &lt;min&gt; &lt;max&gt; //指定输出score区间内的成员
</span></span><span class="line"><span class="cl">zincrby &lt;key&gt; &lt;increment&gt; &lt;value&gt; //为value元素的分数加上增量
</span></span><span class="line"><span class="cl">zrem &lt;key&gt; &lt;value&gt; //移除有序集合中的一个或多个成员
</span></span><span class="line"><span class="cl">zcard &lt;key&gt; //获取集合中的元素数量
</span></span><span class="line"><span class="cl">zcount &lt;key&gt; &lt;min&gt; &lt;max&gt; //计算在有序集合中指定区间分数的成员数
</span></span><span class="line"><span class="cl">zrank &lt;key&gt; &lt;value&gt; 返回有序集合指定成员的排名
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="使用zset实现文章访问量的排行">使用zset实现文章访问量的排行</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">redis2:0&gt;zadd test 100000 java 80000 python 50000 php 120000 c++ 20000 js
</span></span><span class="line"><span class="cl">&#34;5&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">redis2:0&gt;zrevrange test 0 -1
</span></span><span class="line"><span class="cl"> 1)  &#34;c++&#34;
</span></span><span class="line"><span class="cl"> 2)  &#34;java&#34;
</span></span><span class="line"><span class="cl"> 3)  &#34;python&#34;
</span></span><span class="line"><span class="cl"> 4)  &#34;php&#34;
</span></span><span class="line"><span class="cl"> 5)  &#34;js&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">redis2:0&gt;zrevrangebyscore test 120000 10redis2:0&gt;0000
</span></span><span class="line"><span class="cl"> 1)  &#34;c++&#34;
</span></span><span class="line"><span class="cl"> 2)  &#34;java&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="三redis的相关配置">三.Redis的相关配置</h2>
<ol>
<li>ip地址绑定
<ul>
<li>默认 “bind 127.0.0.1”只接受本机访问</li>
<li>使其他机器访问解决方法
<ol>
<li>注释“bind 127.0.0.1” 取消绑定id</li>
<li>“protected-mode yes” yes改为no 关闭保护模式</li>
</ol>
</li>
</ul>
</li>
<li>tcp-backlog
<ul>
<li>默认“tcp-backlog 511”</li>
<li>可以理解为请求到达后至进程处理前的队列</li>
</ul>
</li>
<li>timeout
<ul>
<li>一个空闲的客户端维持多长时间(秒)会关闭，0代表永不关闭，默认0</li>
</ul>
</li>
<li>tcp-keepalive
<ul>
<li>对客户端的心跳检测 官方推荐60s</li>
</ul>
</li>
<li>daemonize
<ul>
<li>是否为后台进程</li>
</ul>
</li>
<li>pidfile
<ul>
<li>存放pid文件的位置</li>
</ul>
</li>
<li>loglevel
<ul>
<li>默认 loglevel notice</li>
<li>日志级别 四个等级</li>
</ul>
</li>
<li>database
<ul>
<li>设定库的数量 默认16</li>
</ul>
</li>
<li>maxclient
<ul>
<li>最大客户端链接数</li>
</ul>
</li>
<li>maxmemory
<ul>
<li>设置内存量</li>
<li>超过后 会根据maxmemory-policy指定移除</li>
</ul>
</li>
<li>maxmemory-policy
<ul>
<li>volatile-lru  使用LRU（最近最少使用）算法移除key，只对设置了过期时间的键</li>
<li>allkeys-lru 使用LRU算法移除key</li>
<li>volatile-random 在过期集合中移除key，只对设置了过期时间的键</li>
<li>allkeys-random 随机移除</li>
<li>volatile-ttl(即将过期) 移除ttl最小的key</li>
<li>noeviction 不移除(头铁 等着报错)</li>
</ul>
</li>
<li>maxmemory-samples
<ul>
<li>设置样本大小</li>
<li>3-7 一般3或5</li>
</ul>
</li>
</ol>
<h2 id="四连接javassm">四.连接java(SSM)</h2>
<ol>
<li>
<p>jar：</p>
<ul>
<li>jedis-xxx.jar</li>
</ul>
</li>
<li>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.jsh</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">redis.clients.jedis.Jedis</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Jedis</span><span class="o">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="o">,</span><span class="n">6379</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">ping</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//        jedis.set(&#34;a&#34;,&#34;a&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">jedis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;a&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;a&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="手机短信验证例子">手机短信验证例子</h3>
<ol>
<li>前端</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">		          <span class="o">&lt;</span><span class="n">form</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;navbar-form navbar-left&#34;</span> <span class="n">role</span><span class="o">=</span><span class="s">&#34;search&#34;</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;codeform&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">				  <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;form-group&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">				    <span class="o">&lt;</span><span class="n">input</span> <span class="n">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;form-control&#34;</span> <span class="n">placeholder</span><span class="o">=</span><span class="s">&#34;填写手机号&#34;</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;phone_no&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">				    <span class="o">&lt;</span><span class="n">button</span> <span class="n">type</span><span class="o">=</span><span class="s">&#34;button&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;btn btn-default&#34;</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;sendCode&#34;</span><span class="o">&gt;</span><span class="n">发送验证码</span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;&lt;</span><span class="n">br</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">				    <span class="o">&lt;</span><span class="n">font</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;countdown&#34;</span> <span class="n">color</span><span class="o">=</span><span class="s">&#34;red&#34;</span> <span class="o">&gt;&lt;/</span><span class="n">font</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">				    <span class="o">&lt;</span><span class="n">br</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">				    <span class="o">&lt;</span><span class="n">input</span> <span class="n">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;form-control&#34;</span> <span class="n">placeholder</span><span class="o">=</span><span class="s">&#34;填写验证码&#34;</span> <span class="n">name</span><span class="o">=</span><span class="s">&#34;verify_code&#34;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">				    <span class="o">&lt;</span><span class="n">button</span> <span class="n">type</span><span class="o">=</span><span class="s">&#34;button&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s">&#34;btn btn-default&#34;</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;verifyCode&#34;</span><span class="o">&gt;</span><span class="n">确定</span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">				    <span class="o">&lt;</span><span class="n">font</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;result&#34;</span> <span class="n">color</span><span class="o">=</span><span class="s">&#34;green&#34;</span> <span class="o">&gt;&lt;/</span><span class="n">font</span><span class="o">&gt;&lt;</span><span class="n">font</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;error&#34;</span> <span class="n">color</span><span class="o">=</span><span class="s">&#34;red&#34;</span> <span class="o">&gt;&lt;/</span><span class="n">font</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">				    <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">				    <span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">script</span> <span class="n">type</span><span class="o">=</span><span class="s">&#34;text/javascript&#34;</span><span class="o">&gt;</span> 
</span></span><span class="line"><span class="cl"><span class="n">var</span> <span class="n">t</span><span class="o">=</span><span class="n">120</span><span class="o">;</span><span class="c1">//设定倒计时的时间 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">var</span> <span class="n">interval</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="n">function</span> <span class="nf">refer</span><span class="o">(){</span>  
</span></span><span class="line"><span class="cl">    <span class="n">$</span><span class="o">(</span><span class="s">&#34;#countdown&#34;</span><span class="o">).</span><span class="na">text</span><span class="o">(</span><span class="s">&#34;请于&#34;</span><span class="o">+</span><span class="n">t</span><span class="o">+</span><span class="s">&#34;秒内填写验证码 &#34;</span><span class="o">);</span> <span class="c1">// 显示倒计时 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">t</span><span class="o">--;</span> <span class="c1">// 计数器递减 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="o">(</span><span class="n">t</span><span class="o">&lt;=</span><span class="n">0</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">    	<span class="n">clearInterval</span><span class="o">(</span><span class="n">interval</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    	<span class="n">$</span><span class="o">(</span><span class="s">&#34;#countdown&#34;</span><span class="o">).</span><span class="na">text</span><span class="o">(</span><span class="s">&#34;验证码已失效，请重新发送！ &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span> 
</span></span><span class="line"><span class="cl"><span class="n">$</span><span class="o">(</span><span class="n">function</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">	<span class="n">$</span><span class="o">(</span><span class="s">&#34;#sendCode&#34;</span><span class="o">).</span><span class="na">click</span><span class="o">(</span> <span class="n">function</span> <span class="o">()</span> <span class="o">{</span>       	   <span class="n">$</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="s">&#34;/Verify_code/CodeSenderServlet&#34;</span><span class="o">,</span><span class="n">$</span><span class="o">(</span><span class="s">&#34;#codeform&#34;</span><span class="o">).</span><span class="na">serialize</span><span class="o">(),</span><span class="n">function</span><span class="o">(</span><span class="n">data</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">	    	 <span class="k">if</span><span class="o">(</span><span class="n">data</span><span class="o">==</span><span class="s">&#34;true&#34;</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">	    		 <span class="n">t</span><span class="o">=</span><span class="n">120</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	    		 <span class="n">clearInterval</span><span class="o">(</span><span class="n">interval</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	    		 <span class="n">interval</span><span class="o">=</span> <span class="n">setInterval</span><span class="o">(</span><span class="s">&#34;refer()&#34;</span><span class="o">,</span><span class="n">1000</span><span class="o">);</span><span class="c1">//启动1秒定时  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	   		 <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">data</span><span class="o">==</span><span class="s">&#34;limit&#34;</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">	   			<span class="n">clearInterval</span><span class="o">(</span><span class="n">interval</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	   			<span class="n">$</span><span class="o">(</span><span class="s">&#34;#countdown&#34;</span><span class="o">).</span><span class="na">text</span><span class="o">(</span><span class="s">&#34;单日发送超过次数！ &#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	   		 <span class="o">}</span>
</span></span><span class="line"><span class="cl">		  <span class="o">});</span>   
</span></span><span class="line"><span class="cl">    <span class="o">});</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="n">$</span><span class="o">(</span><span class="s">&#34;#verifyCode&#34;</span><span class="o">).</span><span class="na">click</span><span class="o">(</span> <span class="n">function</span> <span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="n">$</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="s">&#34;/Verify_code/CodeVerifyServlet&#34;</span><span class="o">,</span><span class="n">$</span><span class="o">(</span><span class="s">&#34;#codeform&#34;</span><span class="o">).</span><span class="na">serialize</span><span class="o">(),</span><span class="n">function</span><span class="o">(</span><span class="n">data</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">	    	 <span class="k">if</span><span class="o">(</span><span class="n">data</span><span class="o">==</span><span class="s">&#34;true&#34;</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">	    		 <span class="n">$</span><span class="o">(</span><span class="s">&#34;#result&#34;</span><span class="o">).</span><span class="na">attr</span><span class="o">(</span><span class="s">&#34;color&#34;</span><span class="o">,</span><span class="s">&#34;green&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	    		 <span class="n">$</span><span class="o">(</span><span class="s">&#34;#result&#34;</span><span class="o">).</span><span class="na">text</span><span class="o">(</span><span class="s">&#34;验证成功&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	    		 <span class="n">clearInterval</span><span class="o">(</span><span class="n">interval</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	    		 <span class="n">$</span><span class="o">(</span><span class="s">&#34;#countdown&#34;</span><span class="o">).</span><span class="na">text</span><span class="o">(</span><span class="s">&#34;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	   		 <span class="o">}</span><span class="k">else</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">	    		 <span class="n">$</span><span class="o">(</span><span class="s">&#34;#result&#34;</span><span class="o">).</span><span class="na">attr</span><span class="o">(</span><span class="s">&#34;color&#34;</span><span class="o">,</span><span class="s">&#34;red&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	    		 <span class="n">$</span><span class="o">(</span><span class="s">&#34;#result&#34;</span><span class="o">).</span><span class="na">text</span><span class="o">(</span><span class="s">&#34;验证失败&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	   		 <span class="o">}</span>
</span></span><span class="line"><span class="cl">		  <span class="o">});</span>   
</span></span><span class="line"><span class="cl">    <span class="o">});</span>		
</span></span><span class="line"><span class="cl"><span class="o">});</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>
<p>controller</p>
<ul>
<li>
<p>模拟接收短信验证码并缓存</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@WebServlet</span><span class="o">(</span><span class="s">&#34;/CodeSenderServlet&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CodeSenderServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">1L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @see HttpServlet#HttpServlet()
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">CodeSenderServlet</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO Auto-generated constructor stub
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doPost</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">//获取手机号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">String</span> <span class="n">phone_no</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;phone_no&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//模拟获取验证码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">String</span> <span class="n">code</span> <span class="o">=</span> <span class="n">getCode</span><span class="o">(</span><span class="n">6</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//拼接key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">String</span> <span class="n">codeKey</span> <span class="o">=</span> <span class="s">&#34;Verify_code:&#34;</span> <span class="o">+</span> <span class="n">phone_no</span> <span class="o">+</span> <span class="s">&#34;:code&#34;</span><span class="o">;</span><span class="c1">//Verify_code:12345:code
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">String</span> <span class="n">countKey</span> <span class="o">=</span> <span class="s">&#34;Verify_code:&#34;</span> <span class="o">+</span> <span class="n">phone_no</span> <span class="o">+</span> <span class="s">&#34;:count&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Jedis</span><span class="o">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="o">,</span> <span class="n">6379</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//判断发送验证码的次数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">String</span> <span class="n">count</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">countKey</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="o">(</span><span class="n">count</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">//代表第一次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">jedis</span><span class="o">.</span><span class="na">setex</span><span class="o">(</span><span class="n">countKey</span><span class="o">,</span> <span class="n">24</span><span class="o">*</span><span class="n">60</span><span class="o">*</span><span class="n">60</span><span class="o">,</span> <span class="s">&#34;1&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">count</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">jedis</span><span class="o">.</span><span class="na">incr</span><span class="o">(</span><span class="n">countKey</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">count</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">print</span><span class="o">(</span><span class="s">&#34;limit&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//向redis中进行存储，以手机号为键，以验证码为值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">jedis</span><span class="o">.</span><span class="na">setex</span><span class="o">(</span><span class="n">codeKey</span><span class="o">,</span> <span class="n">120</span><span class="o">,</span> <span class="n">code</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">print</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//模拟短信
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">private</span> <span class="n">String</span> <span class="nf">getCode</span><span class="o">(</span><span class="kt">int</span> <span class="n">length</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">String</span> <span class="n">code</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">Random</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="kt">int</span> <span class="n">rand</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">10</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">code</span> <span class="o">+=</span> <span class="n">rand</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">code</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>从缓存中取出返回到前端</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.atguigu.servlet</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@WebServlet</span><span class="o">(</span><span class="s">&#34;/CodeVerifyServlet&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CodeVerifyServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">1L</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @see HttpServlet#HttpServlet()
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">CodeVerifyServlet</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO Auto-generated constructor stub
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doPost</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">//获取验证码和手机号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">String</span> <span class="n">phone_no</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;phone_no&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">String</span> <span class="n">verify_code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;verify_code&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//拼接key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">String</span> <span class="n">codeKey</span> <span class="o">=</span> <span class="s">&#34;Verify_code:&#34;</span> <span class="o">+</span> <span class="n">phone_no</span> <span class="o">+</span> <span class="s">&#34;:code&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//从redis中获取手机号所对应的验证码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Jedis</span><span class="o">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="o">,</span> <span class="n">6379</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">String</span> <span class="n">code</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">codeKey</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="o">(</span><span class="n">code</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">verify_code</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">print</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="o">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
<h2 id="五redis事务">五.Redis事务</h2>
<ul>
<li>编译出错会直接取消 例如：单词拼写错误</li>
<li>某一步如果在运行时出错 只会取消那一步的操作</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">multi //开启事务
</span></span><span class="line"><span class="cl">exec //提交事务
</span></span><span class="line"><span class="cl">discard //取消事务
</span></span></code></pre></td></tr></table>
</div>
</div><p>演示</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">redis2:0&gt;multi
</span></span><span class="line"><span class="cl">&#34;OK&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">redis2:0&gt;set a a
</span></span><span class="line"><span class="cl">&#34;QUEUED&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">redis2:0&gt;set b c
</span></span><span class="line"><span class="cl">&#34;QUEUED&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">redis2:0&gt;exec
</span></span><span class="line"><span class="cl"> 1)  &#34;OK&#34;
</span></span><span class="line"><span class="cl"> 2)  &#34;OK&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="监视">监视</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">watch &lt;key&gt; //监视key 如果发现被改变 事务取消
</span></span><span class="line"><span class="cl">unwatch // 取消对所有key的监视 如果exec或discard执行了 就不需要再执行unwatch
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="三特性">三特性</h4>
<ol>
<li>单独的隔离操作：事务中的所有命令都会序列化，按顺序的执行。事务在等待执行的时候，不会被其他客户端发送来的米命令请求打断</li>
<li>没有隔离级别的概念：队列中的所有命令没有提交exec之前都是不会被执行的</li>
<li>不保证原子性：redis中如果一条命令执行失败，其后的命令仍然会被执行，没有回滚</li>
</ol>
<h2 id="六持久化">六.持久化</h2>
<h3 id="rdb">RDB</h3>
<blockquote>
<p>在指定的时间间隔内生成内存中整个数据集的持久化快照。快照文件默认被存储在当前文件夹中，名称为<code>dump.rdb</code>，可以通过dir和dbfilename参数来修改默认值。</p>
<p>恢复数据特别快，节省空间，存储的是数据</p>
<p>Redis会单独创建（fork）一个子进程来进行持久化，会先将数据写入到一个临时文件中，待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件。 整个过程中，主进程是不进行任何的IO操作的，这就确保了极高的性能。</p>
<p>缺点：最后一次持久化后数据可能丢失</p>
</blockquote>
<h4 id="配置文件">配置文件</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># redis是基于内存的数据库，可以通过设置该值定期写入磁盘。 
</span></span><span class="line"><span class="cl"># 注释掉“save”这一行配置项就可以让保存数据库功能失效 
</span></span><span class="line"><span class="cl"># 900秒（15分钟）内至少1个key值改变（则进行数据库保存--持久化） 
</span></span><span class="line"><span class="cl"># 300秒（5分钟）内至少10个key值改变（则进行数据库保存--持久化） 
</span></span><span class="line"><span class="cl"># 60秒（1分钟）内至少10000个key值改变（则进行数据库保存--持久化） save 900 1 
</span></span><span class="line"><span class="cl">save 300 10 
</span></span><span class="line"><span class="cl">save 60 10000 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#当RDB持久化出现错误后，是否依然进行继续进行工作，yes：不能进行工作，no：可以继续进行工作，可以通过info中的rdb_last_bgsave_status了解RDB持久化是否有错误 
</span></span><span class="line"><span class="cl">stop-writes-on-bgsave-error yes 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#使用压缩rdb文件，rdb文件压缩使用LZF压缩算法，yes：压缩，但是需要一些cpu的消耗。no：不压缩，需要更多的磁盘空间 推荐压缩
</span></span><span class="line"><span class="cl">rdbcompression yes 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#是否校验rdb文件。从rdb格式的第五个版本开始，在rdb文件的末尾会带上CRC64的校验和。这跟有利于文件的容错性，但是在保存rdb文件的时候，会有大概10%的性能损耗，所以如果你追求高性能，可以关闭该配置。 
</span></span><span class="line"><span class="cl">rdbchecksum yes 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#rdb文件的名称 
</span></span><span class="line"><span class="cl">dbfilename dump.rdb 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#数据目录，数据库的写入会在这个目录。
</span></span><span class="line"><span class="cl">dir ./      默认在当前文件夹下
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="触发条件">触发条件</h4>
<ol>
<li>
<p>通过配制文件中的save条件（可自己配置）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">save <span class="m">900</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">save <span class="m">300</span> <span class="m">10</span>
</span></span><span class="line"><span class="cl">save <span class="m">60</span> <span class="m">10000</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>手动通过save和bgsave命令</p>
</li>
</ol>
<ul>
<li>save：save时只管保存，其他不管，全部阻塞</li>
<li>bgsave：redis会在后台异步的进行快照操作，同时还可以响应客户端请求。可以通过lastsave命令获取最后一次成功执行快照的事件</li>
</ul>
<h4 id="如何恢复">如何恢复</h4>
<ul>
<li>关闭Redis</li>
<li>把备份的文件拷贝到工作目录下</li>
<li>启动Redis,会自动加载</li>
</ul>
<h3 id="aof">AOF</h3>
<blockquote>
<p>以日志的形式来记录每个写操作，将Redis执行过的所有写指令记录下来（读操作补不可记录），只许追加文件但不可以改写文件，redis启动之初会读取改文件重新构建数据。保存的是appendonly.aof文件</p>
<p>aof机制默认关闭，可以通过<code>appendonly = yes</code>参数开启aof机制，通过<code>appendfilename = myaoffile.aof</code>指定aof文件名称。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">#aof持久化策略的配置</span>
</span></span><span class="line"><span class="cl"><span class="c1">#no表示不执行fsync，由操作系统保证数据同步到磁盘，速度最快。</span>
</span></span><span class="line"><span class="cl"><span class="c1">#always表示每次写入都执行fsync，以保证数据同步到磁盘。</span>
</span></span><span class="line"><span class="cl"><span class="c1">#everysec表示每秒执行一次fsync，可能会导致丢失这1s数据。</span>
</span></span><span class="line"><span class="cl">appendfsync everysec
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于触发aof重写机制也可以通过配置文件来进行设置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># aof自动重写配置。当目前aof文件大小超过上一次重写的aof文件大小的百分之多少进行重写，即当aof文件增长到一定大小的时候Redis能够调用bgrewriteaof对日志文件进行重写。当前AOF文件大小是上次日志重写得到AOF文件大小的二倍（设置为100）时，自动启动新的日志重写过程。</span>
</span></span><span class="line"><span class="cl">auto-aof-rewrite-percentage <span class="m">100</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 设置允许重写的最小aof文件大小，避免了达到约定百分比但尺寸仍然很小的情况还要重写</span>
</span></span><span class="line"><span class="cl">auto-aof-rewrite-min-size 64mb
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 在aof重写或者写入rdb文件的时候，会执行大量IO，此时对于everysec和always的aof模式来说，执行fsync会造成阻塞过长时间，no-appendfsync-on-rewrite字段设置为默认设置为no，是最安全的方式，不会丢失数据，但是要忍受阻塞的问题。如果对延迟要求很高的应用，这个字段可以设置为yes，，设置为yes表示rewrite期间对新写操作不fsync,暂时存在内存中,不会造成阻塞的问题（因为没有磁盘竞争），等rewrite完成后再写入，这个时候redis会丢失数据。Linux的默认fsync策略是30秒。可能丢失30秒数据。因此，如果应用系统无法忍受延迟，而可以容忍少量的数据丢失，则设置为yes。如果应用系统无法忍受数据丢失，则设置为no。</span>
</span></span><span class="line"><span class="cl">no-appendfsync-on-rewrite no
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="如何恢复-1">如何恢复</h4>
<h5 id="正常恢复">正常恢复</h5>
<p>​    将文件放到dir指定的文件夹下，当redis启动的时候会自动加载数据，注意：<code>aof文件的优先级比dump大</code>。</p>
<h5 id="异常恢复">异常恢复</h5>
<ul>
<li>
<p>有些操作可以直接到appendonly.aof文件里去修改。</p>
<p>eg：使用了flushall这个命令，此刻持久化文件中就会有这么一条命令记录，把它删掉就可以了</p>
</li>
<li>
<p>写坏的文件可以通过 <code>redis-check-aof --fix</code>进行修复</p>
</li>
</ul>
<h4 id="优势">优势</h4>
<ol>
<li>根据不同的策略，可以实现每秒，每一次修改操作的同步持久化，就算在最恶劣的情况下只会丢失不会超过两秒数据。</li>
<li>当文件太大时，会触发重写机制，确保文件不会太大。</li>
<li>文件可以简单的读懂</li>
</ol>
<h4 id="劣势">劣势</h4>
<ol>
<li>aof文件的大小太大，就算有重写机制，但重写所造成的阻塞问题是不可避免的</li>
<li>aof文件恢复速度慢。</li>
</ol>
<h3 id="总结">总结</h3>
<ol>
<li>
<p>如果你只希望你的数据在服务器运行的时候存在，可以不使用任何的持久化方式</p>
</li>
<li>
<p>一般建议同时开启两种持久化方式。AOF进行数据的持久化，确保数据不会丢失太多，而RDB更适合用于备份数据库，留着一个做万一的手段。</p>
</li>
<li>
<p>性能建议：</p>
<p>因为RDB文件只用做后备用途，建议只在slave上持久化RDB文件，而且只要在15分钟备份一次就够了，只保留900 1这条规则。</p>
<p>如果Enalbe AOF,好处是在最恶劣情况下也只会丢失不超过两秒数据，启动脚本较简单只load自己的AOF文件就可以了。代价：1、带来了持续的IO；2、AOF rewrite的最后将rewrite过程中产生的新数据写到新文件造成的阻塞几乎是不可避免的。只要硬盘许可，应该尽量减少AOF rewrite的频率，AOF重写的基础大小默认值64M太小了，可以设到5G以上。默认超过原大小100%大小时重写可以改到适当的数值。</p>
<p>如果不Enable AOF,仅靠Master-Slave Replication 实现高可用性也可以。能省掉一大笔IO也减少了rewrite时带来的系统波动。代价是如果Master/Slave同时宕掉，会丢失10几分钟的数据，启动脚本也要比较两个Master/Slave中的RDB文件，载入较新的那个。新浪微博就选用了这种架构。</p>
</li>
</ol>
<h2 id="七复制masterslaver">七.复制(master/slaver)</h2>
<blockquote>
<p>就是我们常说的主从复制，主机数据更新后根据配置和策略，自动同步到备机的master/slaver机制，Master以写为主，Slave以读为主</p>
<p>读写分离</p>
<p>容灾恢复</p>
<p>主服务器用来写</p>
<p>从服务器用来读</p>
<p>不管何时 从机都和主机数据相同</p>
<p>主机shutdown后，从机等待</p>
</blockquote>
<h3 id="配置配置从服务器不配置主服务器">配置(配置从服务器，不配置主服务器)</h3>
<ul>
<li>拷贝多个redis文件include</li>
<li>开启daemonize yes</li>
<li>Pid文件名字pidfile</li>
<li>指定端口port</li>
<li>Log文件名字</li>
<li>Dump.rdb名字dbfilename</li>
<li>Appendonly关掉或者换名字</li>
<li>如果要永久 在配置文件中 配置 slaveof</li>
</ul>
<p><a href="https://imgchr.com/i/t8PKDH" target="_blank" rel="noopener noreffer "><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://s1.ax1x.com/2020/06/01/t8PKDH.png"
        data-srcset="https://s1.ax1x.com/2020/06/01/t8PKDH.png, https://s1.ax1x.com/2020/06/01/t8PKDH.png 1.5x, https://s1.ax1x.com/2020/06/01/t8PKDH.png 2x"
        data-sizes="auto"
        alt="https://s1.ax1x.com/2020/06/01/t8PKDH.png"
        title="t8PKDH.png" /></a></p>
<p>命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">info replication //打印主从相关信息
</span></span><span class="line"><span class="cl">slaveof &lt;ip&gt; &lt;port&gt; //成为某个实例的从服务器
</span></span><span class="line"><span class="cl">slaveof no one //将从机变为主机
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="薪火相传">薪火相传</h3>
<p>含义:就是上一个Slave可以是下一个slave的Master，Slave同样可以接收其他slaves的连接和同步请求，那么该slave作为了链条中下一个的master,可以有效减轻master的写压力。</p>
<h3 id="哨兵模式">哨兵模式</h3>
<p>反客为主的自动版，能够后台监控Master库是否故障，如果故障了根据投票数自动将slave库转换为主库。一组sentinel能同时监控多个Master。</p>
<p>使用步骤：</p>
<ol>
<li>
<p>在Master对应redis.conf同目录下新建sentinel.conf文件，名字绝对不能错；</p>
</li>
<li>
<p>配置哨兵，在sentinel.conf文件中填入内容(可以配置多个)：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1">#说明：最后一个数字1，表示主机挂掉后slave投票看让谁接替成为主机，得票数多少后成为主机。</span>
</span></span><span class="line"><span class="cl">sentinel monitor 被监控数据库名字（自己起名字） ip port <span class="m">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>启动哨兵模式(路径按照自己的需求进行配置)：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">redis-sentinel  /myredis/sentinel.conf
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>注意：</p>
<ol>
<li>当master挂掉后，会通过选票进行选出下一个master。而且只有使用了sentinel.conf启动的才能开启选票</li>
<li>当原来的master后来后，很不幸变成了slave。</li>
</ol>
<h2 id="八redis集群以后再学">八.Redis集群（以后再学）</h2>
<blockquote>
<p>实现了水平扩容，启动N个节点，将整个数据库储存分布在N个节点中，每个节点存储数据的1/N</p>
</blockquote>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2020-06-01</span>
            </div><div class="post-info-license">
                <span><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/redis/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/">非关系型数据库</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/git/" class="prev" rel="prev" title="Git"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Git</a>
            <a href="/guli-1-mybatis-plus/" class="next" rel="next" title="guli-1-Mybatis-Plus">guli-1-Mybatis-Plus<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2018 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/coderabbit214" target="_blank">coderabbit</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
