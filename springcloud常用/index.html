<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>SpringCloud常用 - 第二大脑</title><meta name="Description" content="第二大脑"><meta property="og:title" content="SpringCloud常用" />
<meta property="og:description" content="SpringCloud常用 Nacos 注册服务中心 启动命令 1 2 //单机 sh startup.sh -m standalone 简介 为什么叫Nacos 前四个字母分别为Naming和Configurat" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/springcloud%E5%B8%B8%E7%94%A8/" /><meta property="og:image" content="http://example.org/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-04T15:56:36+08:00" />
<meta property="article:modified_time" content="2021-09-04T15:56:36+08:00" /><meta property="og:site_name" content="第二大脑" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://example.org/logo.png"/>

<meta name="twitter:title" content="SpringCloud常用"/>
<meta name="twitter:description" content="SpringCloud常用 Nacos 注册服务中心 启动命令 1 2 //单机 sh startup.sh -m standalone 简介 为什么叫Nacos 前四个字母分别为Naming和Configurat"/>
<meta name="application-name" content="第二大脑">
<meta name="apple-mobile-web-app-title" content="第二大脑"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/logo.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://example.org/springcloud%E5%B8%B8%E7%94%A8/" /><link rel="prev" href="http://example.org/gitlab%E7%A7%81%E6%9C%8D%E6%90%AD%E5%BB%BA/" /><link rel="next" href="http://example.org/rocketmq/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "SpringCloud常用",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/example.org\/springcloud%E5%B8%B8%E7%94%A8\/"
        },"genre": "posts","keywords": "微服务, 框架, 整理","wordcount":  21730 ,
        "url": "http:\/\/example.org\/springcloud%E5%B8%B8%E7%94%A8\/","datePublished": "2021-09-04T15:56:36+08:00","dateModified": "2021-09-04T15:56:36+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "coderabbit"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="第二大脑"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/logo.png"
        data-srcset="/logo.png, /logo.png 1.5x, /logo.png 2x"
        data-sizes="auto"
        alt="/logo.png"
        title="/logo.png" />第二大脑</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="第二大脑"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/logo.png"
        data-srcset="/logo.png, /logo.png 1.5x, /logo.png 2x"
        data-sizes="auto"
        alt="/logo.png"
        title="/logo.png" />第二大脑</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">SpringCloud常用</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/coderabbit214" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>coderabbit</a></span>&nbsp;<span class="post-category">included in <a href="/categories/springcloud/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>SpringCloud</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2021-09-04">2021-09-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;21730 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;44 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#nacos-注册服务中心">Nacos 注册服务中心</a>
      <ul>
        <li><a href="#启动命令">启动命令</a></li>
        <li><a href="#简介">简介</a></li>
        <li><a href="#搭建">搭建</a></li>
        <li><a href="#配置中心">配置中心</a>
          <ul>
            <li><a href="#nacos-confifig入门">Nacos Confifig入门</a></li>
            <li><a href="#完整配置">完整配置</a></li>
            <li><a href="#动态刷新">动态刷新</a></li>
            <li><a href="#配置共享">配置共享</a>
              <ul>
                <li><a href="#同一微服务配置共享">同一微服务配置共享</a></li>
                <li><a href="#不同微服务配置共享">不同微服务配置共享</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#nacos持久化">Nacos持久化</a></li>
        <li><a href="#nacos集群">Nacos集群</a></li>
      </ul>
    </li>
    <li><a href="#ribbon-负载均衡">Ribbon 负载均衡</a>
      <ul>
        <li><a href="#配置负载均衡策略">配置负载均衡策略</a></li>
      </ul>
    </li>
    <li><a href="#openfeign-远程调用">OpenFeign 远程调用</a>
      <ul>
        <li><a href="#简单使用">简单使用</a></li>
        <li><a href="#openfeign超时控制">OpenFeign超时控制</a></li>
        <li><a href="#openfeign日志增强">OpenFeign日志增强</a></li>
        <li><a href="#集成sentinel服务降级处理">集成Sentinel,服务降级处理</a></li>
      </ul>
    </li>
    <li><a href="#sentinel-服务保护">Sentinel 服务保护</a>
      <ul>
        <li><a href="#订单微服务集成sentinel">订单微服务集成Sentinel</a></li>
        <li><a href="#安装sentinel控制台">安装Sentinel控制台</a></li>
        <li><a href="#实现一个接口的限流">实现一个接口的限流</a></li>
        <li><a href="#sentinel容错的维度">Sentinel容错的维度</a></li>
        <li><a href="#sentinel规则种类">Sentinel规则种类</a></li>
        <li><a href="#sentinel规则-流控">Sentinel规则-流控</a>
          <ul>
            <li><a href="#流控规则">流控规则</a></li>
            <li><a href="#qps流控">QPS流控</a></li>
            <li><a href="#线程数流控">线程数流控</a></li>
            <li><a href="#流控模式">流控模式</a>
              <ul>
                <li><a href="#直接流控模式">直接流控模式</a></li>
                <li><a href="#关联流控模式">关联流控模式</a></li>
                <li><a href="#链路流控模式">链路流控模式</a></li>
              </ul>
            </li>
            <li><a href="#流控效果">流控效果</a></li>
          </ul>
        </li>
        <li><a href="#sentinel规则-降级">Sentinel规则-降级</a>
          <ul>
            <li><a href="#慢调用比例案例">慢调用比例案例</a></li>
            <li><a href="#异常比例案例">异常比例案例</a></li>
            <li><a href="#异常数案例">异常数案例</a></li>
          </ul>
        </li>
        <li><a href="#sentinel规则-热点">Sentinel规则-热点</a></li>
        <li><a href="#sentinel规则-授权">Sentinel规则-授权</a></li>
        <li><a href="#sentinel规则-系统规则">Sentinel规则-系统规则</a></li>
        <li><a href="#sentinel-自定义异常返回">Sentinel 自定义异常返回</a></li>
        <li><a href="#sentinelresource的使用">@SentinelResource的使用</a></li>
        <li><a href="#sentinel规则持久化">Sentinel规则持久化</a>
          <ul>
            <li><a href="#推模式基于文件">推模式(基于文件)</a></li>
            <li><a href="#拉模式nacos">拉模式（nacos）</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#gateway-网关">Gateway 网关</a>
      <ul>
        <li><a href="#模块搭建">模块搭建</a></li>
        <li><a href="#路由">路由</a></li>
        <li><a href="#断言">断言</a></li>
        <li><a href="#过滤">过滤</a>
          <ul>
            <li><a href="#自定义局部过滤器">自定义局部过滤器</a></li>
            <li><a href="#全局过滤器">全局过滤器</a></li>
          </ul>
        </li>
        <li><a href="#集成sentinel实现网关限流">集成Sentinel实现网关限流</a>
          <ul>
            <li><a href="#网关集成sentinel">网关集成Sentinel</a></li>
            <li><a href="#修改限流默认返回格式">修改限流默认返回格式</a></li>
            <li><a href="#自定义api分组">自定义API分组</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#sleuthzipkin-链路追踪">Sleuth+Zipkin 链路追踪</a>
      <ul>
        <li><a href="#集成链路追踪组件sleuth">集成链路追踪组件Sleuth</a></li>
        <li><a href="#zipkinsleuth整合">Zipkin+Sleuth整合</a></li>
      </ul>
    </li>
    <li><a href="#分布式调度">分布式调度</a>
      <ul>
        <li><a href="#elastic-job">Elastic-Job</a>
          <ul>
            <li><a href="#搭建-1">搭建</a></li>
            <li><a href="#分片">分片</a></li>
            <li><a href="#dataflow类型调度任务">Dataflow类型调度任务</a></li>
            <li><a href="#运维控制台">运维控制台</a>
              <ul>
                <li><a href="#修改elastic-job配置类">修改Elastic-Job配置类</a></li>
                <li><a href="#日志信息表">日志信息表</a></li>
                <li><a href="#控制台搭建">控制台搭建</a>
                  <ul>
                    <li><a href="#搭建步骤">搭建步骤</a></li>
                    <li><a href="#配置及使用">配置及使用</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#canal-数据同步">Canal 数据同步</a>
      <ul>
        <li><a href="#原理">原理</a></li>
        <li><a href="#准备">准备</a></li>
        <li><a href="#启动">启动</a></li>
        <li><a href="#sh脚本">sh脚本</a></li>
        <li><a href="#集成">集成</a></li>
      </ul>
    </li>
    <li><a href="#seata分布式事务">Seata分布式事务</a>
      <ul>
        <li><a href="#seata-at">Seata-At</a>
          <ul>
            <li><a href="#at模式代码实现">AT模式代码实现</a>
              <ul>
                <li><a href="#发起方">发起方</a></li>
                <li><a href="#分支">分支</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#seata-tcc">Seata-TCC</a>
          <ul>
            <li><a href="#tcc模型图">TCC模型图</a></li>
            <li><a href="#异常处理">异常处理</a>
              <ul>
                <li><a href="#空回滚">空回滚</a></li>
                <li><a href="#幂等">幂等</a></li>
                <li><a href="#防悬挂">防悬挂</a></li>
              </ul>
            </li>
            <li><a href="#异常处理流程图">异常处理流程图</a>
              <ul>
                <li><a href="#try方法">Try方法</a></li>
                <li><a href="#comfirm方法">Comfirm方法</a></li>
                <li><a href="#cancel方法">Cancel方法</a></li>
              </ul>
            </li>
            <li><a href="#tcc模式代码实现">TCC模式代码实现</a>
              <ul>
                <li><a href="#发起方-1">发起方</a></li>
                <li><a href="#分支方">分支方</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#其他">其他</a>
      <ul>
        <li><a href="#单服务集群idea">单服务集群IDEA</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="springcloud常用">SpringCloud常用</h1>
<h2 id="nacos-注册服务中心">Nacos 注册服务中心</h2>
<h3 id="启动命令">启动命令</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">//单机
</span></span><span class="line"><span class="cl">sh startup.sh -m standalone
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="简介">简介</h3>
<ol>
<li>
<p>为什么叫Nacos</p>
<ul>
<li>前四个字母分别为Naming和Configuration的前两个字母，最后的s为Service。</li>
</ul>
</li>
<li>
<p>是什么</p>
<ul>
<li>一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。</li>
<li>Nacos: Dynamic Naming and Configuration Service</li>
<li>Nacos就是注册中心＋配置中心的组合 -&gt; Nacos = Eureka+Config+Bus</li>
</ul>
</li>
<li>
<p><strong>核心功能点</strong>:</p>
<ul>
<li>
<p><strong>服务注册</strong>:  Nacos Client会通过发送REST请求想Nacos Server注册自己的服务，提供自身的元数据，比如IP地址，端口等信息。Nacos Server接收到注册请求后，就会把这些元数据存储到一个双层的内存Map中。</p>
</li>
<li>
<p><strong>服务心跳</strong>:  在服务注册后，Nacos Client会维护一个定时心跳来维持统治Nacos Server,说明服务一致处于可用状态，防止被剔除，默认5s发送一次心跳</p>
</li>
<li>
<p><strong>服务同步</strong>:  Nacos Server集群之间会相互同步服务实例，用来保证服务信息的一致性。</p>
</li>
<li>
<p><strong>服务发现</strong>： 服务消费者(Nacos Client)在调用服务提供的服务时，会发送一个REST请求给Nacos Server,获取上面注册的服务清单，并且缓存在Nacos Client本地,同时会在Nacos Client本地开启一个定时任务拉取服务最新的注册表信息更新到本地缓存。</p>
</li>
<li>
<p><strong>服务健康检查</strong>:  Nacos Server 会开启一个定时任务来检查注册服务实例的健康情况，对于超过15s没有收到客户端心跳的实例会将他的healthy属性设置为false(客户端服务发现时不会发现)，如果某个实例超过30s没有收到心跳，直接剔除该实例(被剔除的实例如果恢复发送心跳则会重新注册)</p>
</li>
</ul>
</li>
</ol>
<h3 id="搭建">搭建</h3>
<ol>
<li>
<p>pom</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--nacos客户端--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>yml（添加注册中心地址）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nacos</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="l">localhost:8848</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>在主类上添加**@EnableDiscoveryClient**注解</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableDiscoveryClient</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProductServer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">ProductServer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>查看nacos控制台出现服务</p>
</li>
</ol>
<h3 id="配置中心">配置中心</h3>
<h4 id="nacos-confifig入门">Nacos Confifig入门</h4>
<blockquote>
<p>Nacos中的dataid的组成格式及与SpringBoot配置文件中的匹配规则</p>
<blockquote>
<p>说明：之所以需要配置spring.application.name，是因为它是构成Nacos配置管理dataId 字段的一部分。</p>
<p>在 Nacos Spring Cloud中,dataId的完整格式如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">${prefix}-${spring-profile.active}.${file-extension}
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>prefix默认为spring.application.name的值，也可以通过配置项spring.cloud.nacos.config.prefix来配置。</li>
<li>spring.profile.active即为当前环境对应的 profile，详情可以参考 Spring Boot文档。注意：当spring.profile.active为空时，对应的连接符 - 也将不存在，datald 的拼接格式变成${prefix}.${file-extension}</li>
<li>file-exetension为配置内容的数据格式，可以通过配置项spring .cloud.nacos.config.file-extension来配置。目前只支持properties和yaml类型。</li>
<li>通过Spring Cloud 原生注解@RefreshScope实现配置自动更新。</li>
</ul>
</blockquote>
</blockquote>
<ol>
<li>
<p>搭建nacos环境</p>
</li>
<li>
<p>在商品微服务中引入nacos的依赖</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="nt">&lt;/artifactId&gt;</span> 
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>在微服务中添加nacos config的配置</p>
<p><strong>注意</strong>:不能使用原来的<code>application.yml</code>作为配置文件，而是新建一个<code>bootstrap.yml</code>作为配置文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">配置文件优先级(由高到低):
</span></span><span class="line"><span class="cl">bootstrap.properties -&gt; bootstrap.yml -&gt; application.properties -&gt; application.yml
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">product-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="p">:</span><span class="m">8848</span><span class="w"> </span><span class="c">#nacos中心地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">file-extension</span><span class="p">:</span><span class="w"> </span><span class="l">yaml</span><span class="w"> </span><span class="c"># 配置文件格式</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">profiles</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">active</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w"> </span><span class="c"># 环境标识</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>在nacos中添加配置,然后把商品微服务application.yml配置复制到配置内容中.</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201102093026806.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201102093026806.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201102093026806.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201102093026806.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201102093026806.png"
        title="image-20201102093026806" /></strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201102095324857.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201102095324857.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201102095324857.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201102095324857.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201102095324857.png"
        title="image-20201102095324857" /></p>
</li>
<li>
<p>注释本地的application.yam中的内容， 启动程序进行测试</p>
</li>
<li>
<p>如果依旧可以成功访问程序，说明我们nacos的配置中心功能已经实现</p>
</li>
</ol>
<h4 id="完整配置">完整配置</h4>
<blockquote>
<p>DataID+Group+Namespace确定读取哪个配置文件</p>
<p>dataId的完整格式:${prefix}-${spring-profile.active}.${file-extension}</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">product-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="p">:</span><span class="m">8848</span><span class="w"> </span><span class="c">#nacos中心地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">file-extension</span><span class="p">:</span><span class="w"> </span><span class="l">yaml</span><span class="w"> </span><span class="c"># 配置文件格式</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#        namespace:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#        group:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">profiles</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">active</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w"> </span><span class="c"># 环境标识</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="动态刷新">动态刷新</h4>
<blockquote>
<p>在controller上加注解@RefreshScope</p>
</blockquote>
<h4 id="配置共享">配置共享</h4>
<h5 id="同一微服务配置共享">同一微服务配置共享</h5>
<blockquote>
<p>只需要提取一个以 spring.application.name 命名的配置文件，然后将其所有环境的公共配置放在里面即可</p>
<p>不加「-开发环境」就可以</p>
</blockquote>
<h5 id="不同微服务配置共享">不同微服务配置共享</h5>
<p>不同为服务之间实现配置共享的原理类似于文件引入，就是定义一个公共配置，然后在当前配置中引入。</p>
<ol>
<li>
<p>在nacos中定义一个DataID为global-config.yaml的配置，用于所有微服务共享</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">globalConfig</span><span class="p">:</span><span class="w"> </span><span class="l">global</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201102103412474.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201102103412474.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201102103412474.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201102103412474.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201102103412474.png"
        title="image-20201102103412474" /></strong></p>
</li>
<li>
<p>修改bootstrap.yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">product-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="p">:</span><span class="m">8848</span><span class="w"> </span><span class="c">#nacos中心地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">file-cextension</span><span class="p">:</span><span class="w"> </span><span class="l">yaml</span><span class="w"> </span><span class="c"># 配置文件格式</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">shared-configs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">data-id</span><span class="p">:</span><span class="w"> </span><span class="l">global-config.yaml</span><span class="w"> </span><span class="c"># 配置要引入的配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">refresh</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">profiles</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">active</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w"> </span><span class="c"># 环境标识</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>在NacosConfigController.java中新增一个方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RefreshScope</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NacosConfigController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${appConfig.name}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">appConfigName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${env}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">env</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${globalConfig}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">globalConfig</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/nacosConfig1&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">nacosConfig</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;远程信息:&#34;</span><span class="o">+</span><span class="n">appConfigName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/nacosConfig2&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">nacosConfig2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;公共配置:&#34;</span><span class="o">+</span><span class="n">appConfigName</span><span class="o">+</span><span class="s">&#34;,环境配置信息:&#34;</span><span class="o">+</span><span class="n">env</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/nacosConfig3&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">nacosConfig3</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;全局配置:&#34;</span><span class="o">+</span><span class="n">globalConfig</span><span class="o">+</span><span class="s">&#34;,公共配置:&#34;</span><span class="o">+</span><span class="n">appConfigName</span><span class="o">+</span><span class="s">&#34;,环境配置信息:&#34;</span><span class="o">+</span><span class="n">env</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>重启服务并测试.</p>
</li>
</ol>
<h3 id="nacos持久化">Nacos持久化</h3>
<ol>
<li>
<p>nacos-server-1.1.4\nacos\conf录下找到nacos-mysql.sql文件，执行脚本。</p>
</li>
<li>
<p>nacos-server-1.1.4\nacos\conf目录下找到application.properties，添加以下配置（按需修改对应值）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">spring.datasource.platform</span><span class="o">=</span><span class="s">mysql</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="na">db.num</span><span class="o">=</span><span class="s">1</span>
</span></span><span class="line"><span class="cl"><span class="na">db.url.0</span><span class="o">=</span><span class="s">jdbc:mysql://localhost:3306/nacos_devtest?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true</span>
</span></span><span class="line"><span class="cl"><span class="na">db.user</span><span class="o">=</span><span class="s">root</span>
</span></span><span class="line"><span class="cl"><span class="na">db.password</span><span class="o">=</span><span class="s">1234</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>重启</p>
</li>
</ol>
<h3 id="nacos集群">Nacos集群</h3>
<blockquote>
<p>必须持久化</p>
</blockquote>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/681c3dc16a69f197896cbff482f2298e.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/681c3dc16a69f197896cbff482f2298e.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/681c3dc16a69f197896cbff482f2298e.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/681c3dc16a69f197896cbff482f2298e.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/681c3dc16a69f197896cbff482f2298e.png"
        title="681c3dc16a69f197896cbff482f2298e" /></p>
<ol>
<li>
<p>配置<strong>cluster.conf</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 三个服务器加端口
</span></span><span class="line"><span class="cl">192.168.111.144:3333
</span></span><span class="line"><span class="cl">192.168.111.144:4444
</span></span><span class="line"><span class="cl">192.168.111.144:5555
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>分别启动三个nacos</p>
</li>
<li>
<p>配置nginx作为负载均衡器</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">upstream cluster{
</span></span><span class="line"><span class="cl">	server 127.0.0.1:3333;
</span></span><span class="line"><span class="cl">	server 127.0.0.1:4444;
</span></span><span class="line"><span class="cl">	server 127.0.0.1:5555;
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">server {
</span></span><span class="line"><span class="cl">	listen			1111;
</span></span><span class="line"><span class="cl">	server_name 127.0.0.1;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	location / {
</span></span><span class="line"><span class="cl">			proxy_pass http://cluster;
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>启动2222 3333 4444 nginx</p>
</li>
<li>
<p>测试</p>
<ol>
<li>测试通过nginx，访问nacos - http://127.0.0.1:1111/nacos/#/login</li>
<li>修改配置看是否会同步？会</li>
</ol>
</li>
<li>
<p>让微服务cloudalibaba-provider-payment9002启动注册进nacos集群 - 修改配置文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9002</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nacos-payment-provider</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">c1oud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#配置Nacos地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#server-addr: Localhost:8848</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c">#换成nginx的1111端口，做集群</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.111.144</span><span class="p">:</span><span class="m">1111</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">management</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">endpoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">web</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exposure</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">inc1ude</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>启动微服务cloudalibaba-provider-payment9002</p>
<p>访问nacos，查看注册结果</p>
</li>
<li>
<p>总结</p>
</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/42ff7ef670012437b046f099192d7484.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/42ff7ef670012437b046f099192d7484.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/42ff7ef670012437b046f099192d7484.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/42ff7ef670012437b046f099192d7484.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/42ff7ef670012437b046f099192d7484.png"
        title="42ff7ef670012437b046f099192d7484" /></p>
<h2 id="ribbon-负载均衡">Ribbon 负载均衡</h2>
<h3 id="配置负载均衡策略">配置负载均衡策略</h3>
<p>com.netflix.loadbalancer.IRule , 具体的负载策略如下图所示:</p>
<table>
<thead>
<tr>
<th>策略名</th>
<th>策略描述</th>
<th>实现说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>AvailabilityFilteringRule</td>
<td>先过滤掉故障实例，再选择并发较小的实例；</td>
<td>使用一个AvailabilityPredicate来包含过滤server的逻辑，其实就就是检查status里记录的各个server的运行状态</td>
</tr>
<tr>
<td>WeightedResponseTimeRule</td>
<td>根据相应时间分配一个weight，相应时间越长，weight越小，被选中的可能性越低。</td>
<td>一个后台线程定期的从status里面读取评价响应时间，为每个server计算一个weight。Weight的计算也比较简单responsetime 减去每个server自己平均的responsetime是server的权</td>
</tr>
<tr>
<td>RetryRule</td>
<td>对选定的负载均衡策略机上重试机制。</td>
<td>在一个配置时间段内当选择server不成功，则一直尝试使用subRule的方式选择一个可用的server</td>
</tr>
<tr>
<td>RoundRobinRule</td>
<td>轮询方式轮询选择server</td>
<td>轮询index，选择index对应位置的server</td>
</tr>
<tr>
<td>RandomRule</td>
<td>随机选择一个server</td>
<td>在index上随机，选择index对应位置的server</td>
</tr>
<tr>
<td>BestAvailableRule</td>
<td>选择一个最小的并发请求的server</td>
<td>逐个考察Server，如果Server被tripped了，则忽略，在选择其中ActiveRequestsCount最小的server</td>
</tr>
<tr>
<td>ZoneAvoidanceRule(默认)</td>
<td>复合判断server所在区域的性能和server的可用性选择server</td>
<td>使用ZoneAvoidancePredicate和AvailabilityPredicate来判断是否选择某个server，前一个判断判定一个zone的运行性能是否可用，剔除不可用的zone（的所有server），AvailabilityPredicate用于过滤掉连接数过多的Server。</td>
</tr>
</tbody>
</table>
<p>我们可以通过修改配置来调整Ribbon的负载均衡策略，在application.yml中增加如下配置:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">&lt;调用的服务名&gt;</span><span class="p">:</span><span class="w"> </span><span class="c"># 调用的提供者的名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ribbon</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">NFLoadBalancerRuleClassName</span><span class="p">:</span><span class="w"> </span><span class="l">com.netflix.loadbalancer.RandomRule</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="openfeign-远程调用">OpenFeign 远程调用</h2>
<h3 id="简单使用">简单使用</h3>
<ol>
<li>
<p>pom</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--fegin组件--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>启动类 @EnableFeignClients</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableDiscoveryClient</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableFeignClients</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderServer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">OrderServer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用</p>
<blockquote>
<p>直接复制对应微服务的controller</p>
<p>注意⚠️：</p>
<ul>
<li>请求路径注意复制完整</li>
<li>每个参数都需要注解</li>
</ul>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="nd">@FeignClient</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;cloud-payment-service&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PaymentFeignService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		 <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 方法的参数必须有注解
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @PathVariable 路径变量
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @RequestParam 参数
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @RequestBody  参数对象
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param pid
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/get/{id}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">CommonResult</span> <span class="nf">getPamentById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span><span class="n">Long</span> <span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="openfeign超时控制">OpenFeign超时控制</h3>
<blockquote>
<p><strong>OpenFeign默认等待1秒钟，超过后报错</strong></p>
</blockquote>
<p>yml配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="c">#设置feign客户端超时时间(OpenFeign默认支持ribbon)(单位：毫秒)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ribbon</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">#指的是建立连接所用的时间，适用于网络状况正常的情况下,两端连接所用的时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ReadTimeout</span><span class="p">:</span><span class="w"> </span><span class="m">5000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c">#指的是建立连接后从服务器读取到可用资源所用的时间</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ConnectTimeout</span><span class="p">:</span><span class="w"> </span><span class="m">5000</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="openfeign日志增强">OpenFeign日志增强</h3>
<ol>
<li>
<p>配置日志bean</p>
<ul>
<li>NONE：默认的，不显示任何日志;</li>
<li>BASIC：仅记录请求方法、URL、响应状态码及执行时间;</li>
<li>HEADERS：除了BASIC中定义的信息之外，还有请求和响应的头信息;</li>
<li>FULL：除了HEADERS中定义的信息之外，还有请求和响应的正文及元数据。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">com.atguigu.springcloud.config</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">feign.Logger</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FeignConfig</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="n">Logger</span><span class="o">.</span><span class="na">Level</span> <span class="nf">feignLoggerLevel</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//NONE：默认的，不显示任何日志;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//BASIC：仅记录请求方法、URL、响应状态码及执行时间;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//HEADERS：除了BASIC中定义的信息之外，还有请求和响应的头信息;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//FULL：除了HEADERS中定义的信息之外，还有请求和响应的正文及元数据。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">Logger</span><span class="o">.</span><span class="na">Level</span><span class="o">.</span><span class="na">FULL</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>YML文件里需要开启日志的Feign客户端</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">logging</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">level</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># feign日志以什么级别监控哪个接口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">com.lun.springcloud.service.PaymentFeignService</span><span class="p">:</span><span class="w"> </span><span class="l">debug</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="集成sentinel服务降级处理">集成Sentinel,服务降级处理</h3>
<ol>
<li>
<p>yaml配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">product-service</span><span class="p">:</span><span class="w"> </span><span class="c"># 调用的提供者的名称</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ribbon</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">NFLoadBalancerRuleClassName</span><span class="p">:</span><span class="w"> </span><span class="l">com.netflix.loadbalancer.RandomRule</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2021-09-06%2017.16.23.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2021-09-06%2017.16.23.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2021-09-06%2017.16.23.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2021-09-06%2017.16.23.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2021-09-06%2017.16.23.png"
        title="截屏2021-09-06 17.16.23" /></p>
<ul>
<li>
<p>ProductFeignApi</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@FeignClient</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;product-service&#34;</span><span class="o">,</span><span class="n">fallback</span> <span class="o">=</span> <span class="n">ProductFeignFallBack</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ProductFeignApi</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/product/{pid}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Product</span> <span class="nf">findByPid</span><span class="o">(</span> <span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;pid&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">pid</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>ProductFeignFallBack</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProductFeignFallBack</span> <span class="kd">implements</span> <span class="n">ProductFeignApi</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Product</span> <span class="nf">findByPid</span><span class="o">(</span><span class="n">Long</span> <span class="n">pid</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Product</span> <span class="n">product</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Product</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">product</span><span class="o">.</span><span class="na">setPid</span><span class="o">(-</span><span class="n">1L</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">product</span><span class="o">.</span><span class="na">setPname</span><span class="o">(</span><span class="s">&#34;兜底数据&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">product</span><span class="o">.</span><span class="na">setPprice</span><span class="o">(</span><span class="n">0</span><span class="o">.</span><span class="na">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">product</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ol>
<h2 id="sentinel-服务保护">Sentinel 服务保护</h2>
<h3 id="订单微服务集成sentinel">订单微服务集成Sentinel</h3>
<p>为微服务集成Sentinel非常简单, 只需要加入Sentinel的依赖即可</p>
<p>在shop-order-server项目的pom文件中添加如下依赖</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--sentinel组件--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="安装sentinel控制台">安装Sentinel控制台</h3>
<p>Sentinel 提供一个轻量级的控制台, 它提供机器发现、单机资源实时监控以及规则管理等功能。</p>
<ol>
<li>
<p>下载jar包 <a href="https://github.com/alibaba/Sentinel/releases" target="_blank" rel="noopener noreffer ">https://github.com/alibaba/Sentinel/releases</a></p>
</li>
<li>
<p>启动控制台</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 直接使用jar命令启动项目(控制台本身是一个SpringBoot项目) </span>
</span></span><span class="line"><span class="cl">java -Dserver.port<span class="o">=</span><span class="m">8080</span> -Dcsp.sentinel.dashboard.server<span class="o">=</span>localhost:8080 -Dproject.name<span class="o">=</span>sentinel-dashboard -jar sentinel-dashboard-1.8.0.jar
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>修改shop-order-server项目中的配置文件application.yml,新增如下配置:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">sentinel</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">transport</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9999</span><span class="w"> </span><span class="c">#跟控制台交流的端口,随意指定一个未使用的端口即可 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">dashboard</span><span class="p">:</span><span class="w"> </span><span class="l">localhost:8080</span><span class="w"> </span><span class="c"># 指定控制台服务的地址</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>通过浏览器访问localhost:8080 进入控制台 ( 默认用户名密码是 sentinel/sentinel )</p>
<p>注意: 默认是没显示order-service的，需要访问几次接口，然后再刷新sentinel管控台才可以看到.</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029151420936.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029151420936.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029151420936.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029151420936.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029151420936.png"
        title="image-20201029151420936" /></strong></p>
</li>
</ol>
<h3 id="实现一个接口的限流">实现一个接口的限流</h3>
<p>第一步: 簇点链路&mdash;&gt;流控</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029151937258.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029151937258.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029151937258.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029151937258.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029151937258.png"
        title="image-20201029151937258" /></strong></p>
<p>第二步: 在单机阈值填写一个数值，表示每秒上限的请求数</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029152031334.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029152031334.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029152031334.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029152031334.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029152031334.png"
        title="image-20201029152031334" /></strong></p>
<p>第三步:通过控制台快速频繁访问, 观察效果</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029152401508.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029152401508.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029152401508.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029152401508.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029152401508.png"
        title="image-20201029152401508" /></strong></p>
<h3 id="sentinel容错的维度">Sentinel容错的维度</h3>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029153848900.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029153848900.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029153848900.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029153848900.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029153848900.png"
        title="image-20201029153848900" /></strong></p>
<p><strong>流量控制</strong>：流量控制在网络传输中是一个常用的概念，它用于调整网络包的数据。任意时间到来的请求往往是</p>
<p>随机不可控的，而系统的处理能力是有限的。我们需要根据系统的处理能力对流量进行控制。</p>
<p><strong>熔断降级</strong>：当检测到调用链路中某个资源出现不稳定的表现，例如请求响应时间长或异常比例升高的时候，则</p>
<p>对这个资源的调用进行限制，让请求快速失败，避免影响到其它的资源而导致级联故障。</p>
<p><strong>系统负载保护</strong>：Sentinel 同时提供系统维度的自适应保护能力。当系统负载较高的时候，如果还持续让</p>
<p>请求进入可能会导致系统崩溃，无法响应。在集群环境下，会把本应这台机器承载的流量转发到其</p>
<p>它的机器上去。如果这个时候其它的机器也处在一个边缘状态的时候，Sentinel 提供了对应的保</p>
<p>护机制，让系统的入口流量和系统的负载达到一个平衡，保证系统在能力范围之内处理最多的请</p>
<p>求。</p>
<h3 id="sentinel规则种类">Sentinel规则种类</h3>
<p>Sentinel主要提供了这五种的流量控制，接下来我们每种都给同学们演示一下.</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029160041081.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029160041081.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029160041081.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029160041081.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029160041081.png"
        title="image-20201029160041081" /></strong></p>
<h3 id="sentinel规则-流控">Sentinel规则-流控</h3>
<h4 id="流控规则">流控规则</h4>
<p>流量控制，其原理是监控应用流量的QPS(每秒查询率) 或并发线程数等指标，当达到指定的阈值时</p>
<p>对流量进行控制，以避免被瞬时的流量高峰冲垮，从而保障应用的高可用性。</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029160919062.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029160919062.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029160919062.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029160919062.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029160919062.png"
        title="image-20201029160919062" /></strong></p>
<p><strong>资源名</strong>：唯一名称，默认是请求路径，可自定义</p>
<p><strong>针对来源</strong>：指定对哪个微服务进行限流，默认指default，意思是不区分来源，全部限制</p>
<p><strong>阈值类型/单机阈值</strong>：</p>
<ul>
<li>
<p>QPS（每秒请求数量）: 当调用该接口的QPS达到阈值的时候，进行限流</p>
</li>
<li>
<p>线程数：当调用该接口的线程数达到阈值的时候，进行限流</p>
</li>
</ul>
<p><strong>是否集群</strong>：暂不需要集群</p>
<h4 id="qps流控">QPS流控</h4>
<p>前面演示的QPS流控</p>
<h4 id="线程数流控">线程数流控</h4>
<ol>
<li>
<p>删除掉之前的QPS流控，新增线程数流控</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029162926422.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029162926422.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029162926422.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029162926422.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029162926422.png"
        title="image-20201029162926422" /></strong></p>
</li>
<li>
<p>在Jmeter中新增线程</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029163205306.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029163205306.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029163205306.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029163205306.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029163205306.png"
        title="image-20201029163205306" /></strong></p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029163233714.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029163233714.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029163233714.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029163233714.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029163233714.png"
        title="image-20201029163233714" /></strong></p>
</li>
<li>
<p>访问 localhost:8091/sentinel2 会发现已经被限流</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029163416823.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029163416823.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029163416823.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029163416823.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029163416823.png"
        title="image-20201029163416823" /></strong></p>
</li>
</ol>
<h4 id="流控模式">流控模式</h4>
<p>点击上面设置流控规则的<strong>编辑</strong>按钮，然后在编辑页面点击<strong>高级选项</strong>，会看到有流控模式一栏。</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029164212597.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029164212597.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029164212597.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029164212597.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029164212597.png"
        title="image-20201029164212597" /></strong></p>
<p>sentinel共有三种流控模式，分别是：</p>
<ul>
<li>
<p>直接（默认）：接口达到限流条件时，开启限流</p>
</li>
<li>
<p>关联：当关联的资源达到限流条件时，开启限流 [适合做应用让步]</p>
</li>
<li>
<p>链路：当从某个接口过来的资源达到限流条件时，开启限流</p>
</li>
</ul>
<h5 id="直接流控模式">直接流控模式</h5>
<p>前面演示的案例就是这种.</p>
<h5 id="关联流控模式">关联流控模式</h5>
<p>关联流控模式指的是，当指定接口关联的接口达到限流条件时，开启对指定接口开启限流。</p>
<p><strong>场景</strong>:当两个资源之间具有资源争抢或者依赖关系的时候，这两个资源便具有了关联。比如对数据库同一个字段的读操作和写操作存在争抢，读的速度过高会影响写得速度，写的速度过高会影响读的速度。如果放任读写操作争抢资源，则争抢本身带来的开销会降低整体的吞吐量。可使用关联限流来避免具有关联关系的资源之间过度的争抢.</p>
<ol>
<li>
<p>在SentinelController.java中增加一个方法，重启订单服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/sentinel3&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">String</span> <span class="nf">sentinel3</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="s">&#34;sentinel3&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>配置限流规则, 将流控模式设置为关联，关联资源设置为的 /sentinel2</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029170800980.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029170800980.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029170800980.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029170800980.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029170800980.png"
        title="image-20201029170800980" /></strong></p>
</li>
<li>
<p>通过postman软件向/sentinel2连续发送请求，注意QPS一定要大于3</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029171026368.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029171026368.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029171026368.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029171026368.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029171026368.png"
        title="image-20201029171026368" /></strong></p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029171055757.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029171055757.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029171055757.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029171055757.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029171055757.png"
        title="image-20201029171055757" /></strong></p>
</li>
<li>
<p>访问/sentinel3,会发现已经被限流</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029171402061.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029171402061.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029171402061.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029171402061.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029171402061.png"
        title="image-20201029171402061" /></strong></p>
</li>
</ol>
<h5 id="链路流控模式">链路流控模式</h5>
<p>链路流控模式指的是，当从某个接口过来的资源达到限流条件时，开启限流。</p>
<ol>
<li>
<p>在shop-order-server项目的application.yml文件中新增如下配置:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">sentinel</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">web-context-unify</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>在shop-order-server项目中新增TraceServiceImpl.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">cn.wolfcode.service.impl</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Service</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TraceServiceImpl</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@SentinelResource</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;tranceService&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">tranceService</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;调用tranceService方法&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>在shop-order-server项目中新增TraceController.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">cn.wolfcode.controller</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TraceController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">TraceServiceImpl</span> <span class="n">traceService</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/trace1&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">trace1</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">traceService</span><span class="o">.</span><span class="na">tranceService</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;trace1&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/trace2&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">trace2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">traceService</span><span class="o">.</span><span class="na">tranceService</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;trace2&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>重新启动订单服务并添加链路流控规则</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029175454431.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029175454431.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029175454431.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029175454431.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029175454431.png"
        title="image-20201029175454431" /></strong></p>
</li>
<li>
<p>分别通过 /trace1 和 /trace2 访问, 发现/trace1没问题, /trace2的被限流了</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029175559035.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029175559035.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029175559035.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029175559035.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201029175559035.png"
        title="image-20201029175555499" /></strong></p>
</li>
</ol>
<h4 id="流控效果">流控效果</h4>
<ul>
<li>
<p><strong>快速失败（默认）</strong>: 直接失败，抛出异常，不做任何额外的处理，是最简单的效果</p>
</li>
<li>
<p><strong>Warm Up</strong>：它从开始阈值到最大QPS阈值会有一个缓冲阶段，一开始的阈值是最大QPS阈值的</p>
<p>1/3，然后慢慢增长，直到最大阈值，适用于将突然增大的流量转换为缓步增长的场景。</p>
</li>
<li>
<p><strong>排队等待</strong>：让请求以均匀的速度通过，单机阈值为每秒通过数量，其余的排队等待； 它还会让设</p>
<p>置一个超时时间，当请求超过超时间时间还未处理，则会被丢弃。</p>
</li>
</ul>
<h3 id="sentinel规则-降级">Sentinel规则-降级</h3>
<p>降级规则就是设置当满足什么条件的时候，对服务进行降级。Sentinel提供了三个衡量条件：</p>
<ul>
<li><strong>慢调用比例</strong>: 选择以慢调用比例作为阈值，需要设置允许的慢调用 RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用。当单位统计时长内请求数目大于设置的最小请求数目，并且慢调用的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求响应时间小于设置的慢调用 RT 则结束熔断，若大于设置的慢调用 RT 则会再次被熔断。</li>
<li><strong>异常比例</strong>: 当单位统计时长内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。异常比率的阈值范围是 <code>[0.0, 1.0]</code>，代表 0% - 100%。</li>
<li><strong>异常数</strong>：当单位统计时长内的异常数目超过阈值之后会自动进行熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。</li>
</ul>
<h4 id="慢调用比例案例">慢调用比例案例</h4>
<ol>
<li>
<p>在shop-order-server项目中新增FallBackController.java类,代码如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">cn.wolfcode.controller</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FallBackController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/fallBack1&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">fallBack1</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;fallBack1执行业务逻辑&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//模拟业务耗时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;fallBack1&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>新增降级规则:</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030094205307.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030094205307.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030094205307.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030094205307.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030094205307.png"
        title="image-20201030094205307" /></strong></p>
<p>上面配置表示，如果在1S之内,有【超过1个的请求】且这些请求中【响应时间&gt;最大RT】的【请求数量比例&gt;10%】，就会触发熔断，在接下来的10s之内都不会调用真实方法，直接走降级方法。</p>
<p>比如: 最大RT=900,比例阈值=0.1,熔断时长=10,最小请求数=10</p>
<ul>
<li>
<p>情况1: 1秒内的有20个请求，只有10个请求响应时间&gt;900ms, 那慢调用比例=0.5，这种情况就会触发熔断</p>
</li>
<li>
<p>情况2: 1秒内的有20个请求，只有1个请求响应时间&gt;900ms, 那慢调用比例=0.05，这种情况不会触发熔断</p>
</li>
<li>
<p>情况3: 1秒内的有8个请求，只有6个请求响应时间&gt;900ms, 那慢调用比例=0.75，这种情况不会触发熔断，因为最小请求数这个条件没有满足.</p>
</li>
</ul>
<p><strong>注意</strong>: 我们做实验的时候把最小请求数设置为1，因为在1秒内，手动操作很难在1s内发两个请求过去，所以要做出效果,最好把最小请求数设置为1。</p>
</li>
</ol>
<h4 id="异常比例案例">异常比例案例</h4>
<ol>
<li>
<p>在shop-order-server项目的FallBackController.java类新增fallBack2方法:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="n">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/fallBack2&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">String</span> <span class="nf">fallBack2</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">	<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;fallBack2执行业务逻辑&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//模拟出现异常，异常比例为33%
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="o">(++</span><span class="n">i</span><span class="o">%</span><span class="n">3</span><span class="o">==</span><span class="n">0</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">		<span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="s">&#34;fallBack2&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>新增降级规则:</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030100912417.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030100912417.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030100912417.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030100912417.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030100912417.png"
        title="image-20201030100912417" /></strong></p>
<p>上面配置表示，在1s之内，,有【超过3个的请求】，异常比例30%的情况下，触发熔断，熔断时长为10s.</p>
</li>
</ol>
<h4 id="异常数案例">异常数案例</h4>
<ol>
<li>
<p>在shop-order-server项目的FallBackController.java类新增fallBack3方法:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/fallBack3&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">String</span> <span class="nf">fallBack3</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">	<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;fallBack3执行业务逻辑&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="o">(</span><span class="s">&#34;wolfcode&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">name</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">		<span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">	<span class="o">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="s">&#34;fallBack3&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>新增降级规则</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030102109574.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030102109574.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030102109574.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030102109574.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030102109574.png"
        title="image-20201030102109574" /></strong></p>
<p>上面配置表示，在1s之内，,有【超过3个的请求】，请求中超过2个请求出现异常就会触发熔断，熔断时长为10s</p>
</li>
</ol>
<h3 id="sentinel规则-热点">Sentinel规则-热点</h3>
<p>何为热点？热点即经常访问的数据。很多时候我们希望统计某个热点数据中访问频次最高的 Top K 数据，并对其访问进行限制。比如：</p>
<ul>
<li>商品 ID 为参数，统计一段时间内最常购买的商品 ID 并进行限制</li>
<li>用户 ID 为参数，针对一段时间内频繁访问的用户 ID 进行限制</li>
</ul>
<p>热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流。热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效。</p>
<ol>
<li>
<p>在shop-order-server项目中新增HotSpotController.java,代码如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">cn.wolfcode.controller</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HotSpotController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/hotSpot1&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@SentinelResource</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;hotSpot1&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">hotSpot1</span><span class="o">(</span><span class="n">Long</span> <span class="n">productId</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;访问编号为:{}的商品&#34;</span><span class="o">,</span><span class="n">productId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;hotSpot1&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意:一定需要在请求方法上贴@SentinelResource直接，否则热点规则无效</p>
</li>
<li>
<p>新增热点规则:</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030104511784.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030104511784.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030104511784.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030104511784.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030104511784.png"
        title="image-20201030104511784" /></strong></p>
</li>
<li>
<p>在热点规则中编辑规则,在编辑之前一定要先访问一下/hotSpot1,不然参数规则无法新增.</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030104633745.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030104633745.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030104633745.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030104633745.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030104633745.png"
        title="image-20201030104633745" /></strong></p>
</li>
<li>
<p>新增参数规则:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1625630523922.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1625630523922.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1625630523922.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1625630523922.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1625630523922.png"
        title="1625630523922" /></p>
</li>
<li>
<p>点击保存，可以看到已经新增了参数规则.</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030104957789.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030104957789.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030104957789.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030104957789.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030104957789.png"
        title="image-20201030104957789" /></strong></p>
</li>
<li>
<p>访问localhost:8091/hotSpot?productId=1 访问会降级</p>
<p>访问localhost:8091/hotSpot?productId=2 访问不会降级</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030105114878.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030105114878.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030105114878.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030105114878.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030105114878.png"
        title="image-20201030105114878" /></strong></p>
</li>
</ol>
<h3 id="sentinel规则-授权">Sentinel规则-授权</h3>
<p>很多时候，我们需要根据调用来源来判断该次请求是否允许放行，这时候可以使用 Sentinel 的来源访问控制（黑白名单控制）的功能。来源访问控制根据资源的请求来源（<code>origin</code>）限制资源是否通过，若配置白名单则只有请求来源位于白名单内时才可通过；若配置黑名单则请求来源位于黑名单时不通过，其余的请求通过。</p>
<ol>
<li>
<p>在shop-order-server中新建RequestOriginParserDefinition.java,定义请求来源如何获取</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RequestOriginParserDefinition</span> <span class="kd">implements</span> <span class="n">RequestOriginParser</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">parseOrigin</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         *  定义从请求的什么地方获取来源信息
</span></span></span><span class="line"><span class="cl"><span class="cm">         *  比如我们可以要求所有的客户端需要在请求头中携带来源信息
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">serviceName</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">&#34;serviceName&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">serviceName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>在shop-order-server中新建AuthController.java,代码如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/auth1&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">auth1</span><span class="o">(</span><span class="n">String</span> <span class="n">serviceName</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;应用:{},访问接口&#34;</span><span class="o">,</span><span class="n">serviceName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;auth1&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>新增授权规则</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030110821985.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030110821985.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030110821985.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030110821985.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030110821985.png"
        title="image-20201030110821985" /></strong></p>
</li>
<li>
<p>访问测试</p>
<p>访问localhost:8091/auth1?serviceName=pc 不能访问</p>
<p>访问localhost:8091/auth1?serviceName=app 可以访问</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030110934370.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030110934370.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030110934370.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030110934370.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030110934370.png"
        title="image-20201030110934370" /></strong></p>
</li>
</ol>
<h3 id="sentinel规则-系统规则">Sentinel规则-系统规则</h3>
<p>系统保护规则是从应用级别的入口流量进行控制，从单台机器的 load、CPU 使用率、平均 RT、入口 QPS 和并发线程数等几个维度监控应用指标，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p>
<p>系统保护规则是应用整体维度的，而不是资源维度的，并且<strong>仅对入口流量生效</strong>。入口流量指的是进入应用的流量（<code>EntryType.IN</code>），比如 Web 服务或 Dubbo 服务端接收的请求，都属于入口流量。</p>
<p>系统规则支持以下的模式：</p>
<ul>
<li><strong>Load 自适应</strong>（仅对 Linux/Unix-like 机器生效）：系统的 load 作为启发指标，进行自适应系统保护。当系统 load 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 <code>maxQps * minRt</code> 估算得出。设定参考值一般是 <code>CPU cores * 2.5</code>。</li>
<li><strong>CPU usage</strong>（1.5.0+ 版本）：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。</li>
<li><strong>平均 RT</strong>：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。</li>
<li><strong>并发线程数</strong>：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</li>
<li><strong>入口 QPS</strong>：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。</li>
</ul>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030111407594.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030111407594.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030111407594.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030111407594.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030111407594.png"
        title="image-20201030111407594" /></strong></p>
<h3 id="sentinel-自定义异常返回">Sentinel 自定义异常返回</h3>
<p>当前面设定的规则没有满足是，我们可以自定义异常返回.</p>
<ul>
<li>
<p>FlowException 限流异常</p>
</li>
<li>
<p>DegradeException 降级异常</p>
</li>
<li>
<p>ParamFlowException 参数限流异常</p>
</li>
<li>
<p>AuthorityException 授权异常</p>
</li>
<li>
<p>SystemBlockException 系统负载异常</p>
</li>
</ul>
<p>在shop-order-server项目中定义异常返回处理类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">cn.wolfcode.error</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExceptionHandlerPage</span> <span class="kd">implements</span> <span class="n">BlockExceptionHandler</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">BlockException</span> <span class="n">e</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">&#34;application/json;charset=utf-8&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ResultData</span> <span class="n">data</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="n">FlowException</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResultData</span><span class="o">(-</span><span class="n">1</span><span class="o">,</span> <span class="s">&#34;接口被限流了&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="n">DegradeException</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResultData</span><span class="o">(-</span><span class="n">2</span><span class="o">,</span> <span class="s">&#34;接口被降级了&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="n">ParamFlowException</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResultData</span><span class="o">(-</span><span class="n">3</span><span class="o">,</span> <span class="s">&#34;参数限流异常&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="n">AuthorityException</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResultData</span><span class="o">(-</span><span class="n">4</span><span class="o">,</span> <span class="s">&#34;授权异常&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="n">SystemBlockException</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ResultData</span><span class="o">(-</span><span class="n">5</span><span class="o">,</span> <span class="s">&#34;接口被降级了...&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">.</span><span class="na">getWriter</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">data</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Data</span>
</span></span><span class="line"><span class="cl"><span class="nd">@AllArgsConstructor</span><span class="c1">//全参构造
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@NoArgsConstructor</span><span class="c1">//无参构造
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">class</span> <span class="nc">ResultData</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">code</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">message</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="sentinelresource的使用">@SentinelResource的使用</h3>
<p>在定义了资源点之后，我们可以通过Dashboard来设置限流和降级策略来对资源点进行保护。同时还能</p>
<p>通过@SentinelResource来指定出现异常时的处理策略。</p>
<p>@SentinelResource 用于定义资源，并提供可选的异常处理和 fallback 配置项。</p>
<p>其主要参数如下:</p>
<table>
<thead>
<tr>
<th style="text-align:left">属性</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">value</td>
<td>资源名称，必需项（不能为空）</td>
</tr>
<tr>
<td style="text-align:left">entryType</td>
<td>entry 类型，可选项（默认为 <code>EntryType.OUT</code>）</td>
</tr>
<tr>
<td style="text-align:left">blockHandler<code>/</code>blockHandlerClass</td>
<td><code>blockHandler</code> 对应处理 <code>BlockException</code> 的函数名称，可选项。blockHandler 函数访问范围需要是 <code>public</code>，返回类型需要与原方法相匹配，参数类型需要和原方法相匹配并且最后加一个额外的参数，类型为 <code>BlockException</code>。blockHandler 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 <code>blockHandlerClass</code> 为对应的类的 <code>Class</code> 对象，注意对应的函数必需为 static 函数，否则无法解析。</td>
</tr>
<tr>
<td style="text-align:left">fallback<code>/</code>fallbackClass</td>
<td>fallback 函数名称，可选项，用于在抛出异常的时候提供 fallback 处理逻辑。fallback 函数可以针对所有类型的异常（除了 <code>exceptionsToIgnore</code> 里面排除掉的异常类型）进行处理。fallback 函数签名和位置要求：<br />1. 返回值类型必须与原函数返回值类型一致； <br />2.方法参数列表需要和原函数一致，或者可以额外多一个 <code>Throwable</code> 类型的参数用于接收对应的异常。<br />3.fallback 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 <code>fallbackClass</code> 为对应的类的 <code>Class</code> 对象，注意对应的函数必需为 static 函数，否则无法解析。</td>
</tr>
<tr>
<td style="text-align:left"><code>defaultFallback</code></td>
<td>默认的 fallback 函数名称，可选项，通常用于通用的 fallback 逻辑（即可以用于很多服务或方法）。默认 fallback 函数可以针对所有类型的异常（除了 <code>exceptionsToIgnore</code> 里面排除掉的异常类型）进行处理。若同时配置了 fallback 和 defaultFallback，则只有 fallback 会生效。defaultFallback 函数签名要求：<br />1. 返回值类型必须与原函数返回值类型一致；<br />2. 方法参数列表需要为空，或者可以额外多一个 <code>Throwable</code> 类型的参数用于接收对应的异常。 <br />3. defaultFallback 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 <code>fallbackClass</code> 为对应的类的 <code>Class</code> 对象，注意对应的函数必需为 static 函数，否则无法解析。</td>
</tr>
<tr>
<td style="text-align:left"><code>exceptionsToIgnore</code></td>
<td>用于指定哪些异常被排除掉，不会计入异常统计中，也不会进入 fallback 逻辑中，而是会原样抛出。</td>
</tr>
</tbody>
</table>
<p><strong>定义限流和降级后的处理方法</strong></p>
<p>直接将限流和降级方法定义在方法中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">cn.wolfcode.controller</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnnoController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/anno1&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@SentinelResource</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;anno1&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">blockHandler</span><span class="o">=</span><span class="s">&#34;anno1BlockHandler&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">fallback</span> <span class="o">=</span> <span class="s">&#34;anno1Fallback&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">anno1</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="o">(</span><span class="s">&#34;wolfcode&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">name</span><span class="o">)){</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;anno1&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">anno1BlockHandler</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span><span class="n">BlockException</span> <span class="n">ex</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;{}&#34;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;接口被限流或者降级了&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Throwable时进入的方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">anno1Fallback</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span><span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;{}&#34;</span><span class="o">,</span> <span class="n">throwable</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;接口发生异常了&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="sentinel规则持久化">Sentinel规则持久化</h3>
<h4 id="推模式基于文件">推模式(基于文件)</h4>
<p>​	通过前面的讲解，我们已经知道，可以通过Dashboard来为每个Sentinel客户端设置各种各样的规</p>
<p>则，但是这里有一个问题，就是这些规则默认是存放在内存中，极不稳定，所以需要将其持久化。</p>
<p>​	本地文件数据源会定时轮询文件的变更，读取规则。这样我们既可以在应用本地直接修改文件来更</p>
<p>新规则，也可以通过 Sentinel 控制台推送规则。以本地文件数据源为例，推送过程如下图所示：</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030135911029.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030135911029.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030135911029.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030135911029.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030135911029.png"
        title="image-20201030135911029" /></strong></p>
<p>首先 Sentinel 控制台通过 API 将规则推送至客户端并更新到内存中，接着注册的写数据源会将新的</p>
<p>规则保存到本地的文件中。</p>
<ol>
<li>
<p>编写处理类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">cn.wolfcode.sentinel</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FilePersistence</span> <span class="kd">implements</span> <span class="n">InitFunc</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${spring.application.name}&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">appcationName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">ruleDir</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;user.home&#34;</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;/sentinel-rules/&#34;</span> <span class="o">+</span> <span class="n">appcationName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">flowRulePath</span> <span class="o">=</span> <span class="n">ruleDir</span> <span class="o">+</span> <span class="s">&#34;/flow-rule.json&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">degradeRulePath</span> <span class="o">=</span> <span class="n">ruleDir</span> <span class="o">+</span> <span class="s">&#34;/degrade-rule.json&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">systemRulePath</span> <span class="o">=</span> <span class="n">ruleDir</span> <span class="o">+</span> <span class="s">&#34;/system-rule.json&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">authorityRulePath</span> <span class="o">=</span> <span class="n">ruleDir</span> <span class="o">+</span> <span class="s">&#34;/authority-rule.json&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">paramFlowRulePath</span> <span class="o">=</span> <span class="n">ruleDir</span> <span class="o">+</span> <span class="s">&#34;/param-flow-rule.json&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">mkdirIfNotExits</span><span class="o">(</span><span class="n">ruleDir</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">createFileIfNotExits</span><span class="o">(</span><span class="n">flowRulePath</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">createFileIfNotExits</span><span class="o">(</span><span class="n">degradeRulePath</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">createFileIfNotExits</span><span class="o">(</span><span class="n">systemRulePath</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">createFileIfNotExits</span><span class="o">(</span><span class="n">authorityRulePath</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">createFileIfNotExits</span><span class="o">(</span><span class="n">paramFlowRulePath</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 流控规则
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ReadableDataSource</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">FlowRule</span><span class="o">&gt;&gt;</span> <span class="n">flowRuleRDS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileRefreshableDataSource</span><span class="o">&lt;&gt;(</span>
</span></span><span class="line"><span class="cl">                <span class="n">flowRulePath</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">flowRuleListParser</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">FlowRuleManager</span><span class="o">.</span><span class="na">register2Property</span><span class="o">(</span><span class="n">flowRuleRDS</span><span class="o">.</span><span class="na">getProperty</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">WritableDataSource</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">FlowRule</span><span class="o">&gt;&gt;</span> <span class="n">flowRuleWDS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileWritableDataSource</span><span class="o">&lt;&gt;(</span>
</span></span><span class="line"><span class="cl">                <span class="n">flowRulePath</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="o">::</span><span class="n">encodeJson</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">WritableDataSourceRegistry</span><span class="o">.</span><span class="na">registerFlowDataSource</span><span class="o">(</span><span class="n">flowRuleWDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 降级规则
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ReadableDataSource</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">DegradeRule</span><span class="o">&gt;&gt;</span> <span class="n">degradeRuleRDS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileRefreshableDataSource</span><span class="o">&lt;&gt;(</span>
</span></span><span class="line"><span class="cl">                <span class="n">degradeRulePath</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">degradeRuleListParser</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">DegradeRuleManager</span><span class="o">.</span><span class="na">register2Property</span><span class="o">(</span><span class="n">degradeRuleRDS</span><span class="o">.</span><span class="na">getProperty</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">WritableDataSource</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">DegradeRule</span><span class="o">&gt;&gt;</span> <span class="n">degradeRuleWDS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileWritableDataSource</span><span class="o">&lt;&gt;(</span>
</span></span><span class="line"><span class="cl">                <span class="n">degradeRulePath</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="o">::</span><span class="n">encodeJson</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">WritableDataSourceRegistry</span><span class="o">.</span><span class="na">registerDegradeDataSource</span><span class="o">(</span><span class="n">degradeRuleWDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 系统规则
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ReadableDataSource</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">SystemRule</span><span class="o">&gt;&gt;</span> <span class="n">systemRuleRDS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileRefreshableDataSource</span><span class="o">&lt;&gt;(</span>
</span></span><span class="line"><span class="cl">                <span class="n">systemRulePath</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">systemRuleListParser</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">SystemRuleManager</span><span class="o">.</span><span class="na">register2Property</span><span class="o">(</span><span class="n">systemRuleRDS</span><span class="o">.</span><span class="na">getProperty</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">WritableDataSource</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">SystemRule</span><span class="o">&gt;&gt;</span> <span class="n">systemRuleWDS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileWritableDataSource</span><span class="o">&lt;&gt;(</span>
</span></span><span class="line"><span class="cl">                <span class="n">systemRulePath</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="o">::</span><span class="n">encodeJson</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">WritableDataSourceRegistry</span><span class="o">.</span><span class="na">registerSystemDataSource</span><span class="o">(</span><span class="n">systemRuleWDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 授权规则
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ReadableDataSource</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">AuthorityRule</span><span class="o">&gt;&gt;</span> <span class="n">authorityRuleRDS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileRefreshableDataSource</span><span class="o">&lt;&gt;(</span>
</span></span><span class="line"><span class="cl">                <span class="n">authorityRulePath</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">authorityRuleListParser</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">AuthorityRuleManager</span><span class="o">.</span><span class="na">register2Property</span><span class="o">(</span><span class="n">authorityRuleRDS</span><span class="o">.</span><span class="na">getProperty</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">WritableDataSource</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuthorityRule</span><span class="o">&gt;&gt;</span> <span class="n">authorityRuleWDS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileWritableDataSource</span><span class="o">&lt;&gt;(</span>
</span></span><span class="line"><span class="cl">                <span class="n">authorityRulePath</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="o">::</span><span class="n">encodeJson</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">WritableDataSourceRegistry</span><span class="o">.</span><span class="na">registerAuthorityDataSource</span><span class="o">(</span><span class="n">authorityRuleWDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 热点参数规则
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ReadableDataSource</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ParamFlowRule</span><span class="o">&gt;&gt;</span> <span class="n">paramFlowRuleRDS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileRefreshableDataSource</span><span class="o">&lt;&gt;(</span>
</span></span><span class="line"><span class="cl">                <span class="n">paramFlowRulePath</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">paramFlowRuleListParser</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ParamFlowRuleManager</span><span class="o">.</span><span class="na">register2Property</span><span class="o">(</span><span class="n">paramFlowRuleRDS</span><span class="o">.</span><span class="na">getProperty</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">WritableDataSource</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ParamFlowRule</span><span class="o">&gt;&gt;</span> <span class="n">paramFlowRuleWDS</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileWritableDataSource</span><span class="o">&lt;&gt;(</span>
</span></span><span class="line"><span class="cl">                <span class="n">paramFlowRulePath</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="o">::</span><span class="n">encodeJson</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ModifyParamFlowRulesCommandHandler</span><span class="o">.</span><span class="na">setWritableDataSource</span><span class="o">(</span><span class="n">paramFlowRuleWDS</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Converter</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">FlowRule</span><span class="o">&gt;&gt;</span> <span class="n">flowRuleListParser</span> <span class="o">=</span> <span class="n">source</span> <span class="o">-&gt;</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">source</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">TypeReference</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">FlowRule</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Converter</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">DegradeRule</span><span class="o">&gt;&gt;</span> <span class="n">degradeRuleListParser</span> <span class="o">=</span> <span class="n">source</span> <span class="o">-&gt;</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">source</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">TypeReference</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">DegradeRule</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Converter</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">SystemRule</span><span class="o">&gt;&gt;</span> <span class="n">systemRuleListParser</span> <span class="o">=</span> <span class="n">source</span> <span class="o">-&gt;</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">source</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">TypeReference</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">SystemRule</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Converter</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">AuthorityRule</span><span class="o">&gt;&gt;</span> <span class="n">authorityRuleListParser</span> <span class="o">=</span> <span class="n">source</span> <span class="o">-&gt;</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">source</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">TypeReference</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">AuthorityRule</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Converter</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ParamFlowRule</span><span class="o">&gt;&gt;</span> <span class="n">paramFlowRuleListParser</span> <span class="o">=</span> <span class="n">source</span> <span class="o">-&gt;</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">source</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">TypeReference</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ParamFlowRule</span><span class="o">&gt;&gt;()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">mkdirIfNotExits</span><span class="o">(</span><span class="n">String</span> <span class="n">filePath</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">filePath</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">file</span><span class="o">.</span><span class="na">mkdirs</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">createFileIfNotExits</span><span class="o">(</span><span class="n">String</span> <span class="n">filePath</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">filePath</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">file</span><span class="o">.</span><span class="na">createNewFile</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">String</span> <span class="nf">encodeJson</span><span class="o">(</span><span class="n">T</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>添加配置</p>
<p>在<code>resources</code>下创建配置目录 <code>META-INF/services</code> ,然后添加文件 <code>com.alibaba.csp.sentinel.init.InitFunc</code></p>
<p>在文件中添加配置类的全路径</p>
<p><code>cn.wolfcode.sentinel.FilePersistence</code></p>
</li>
</ol>
<h4 id="拉模式nacos">拉模式（nacos）</h4>
<p>修改cloudalibaba-sentinel-service8401</p>
<p>POM</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="c">&lt;!--SpringCloud ailibaba sentinel-datasource-nacos 后续做持久化用到--&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>com.alibaba.csp<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>sentinel-datasource-nacos<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>YML</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8401</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloudalibaba-sentinel-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="l">localhost:8848</span><span class="w"> </span><span class="c">#Nacos服务注册中心地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">sentinel</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">transport</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">dashboard</span><span class="p">:</span><span class="w"> </span><span class="l">localhost:8080</span><span class="w"> </span><span class="c">#配置Sentinel dashboard地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8719</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">datasource</span><span class="p">:</span><span class="w"> </span><span class="c">#&lt;---------------------------关注点，添加Nacos数据源配置</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ds1</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="l">localhost:8848</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">dataId</span><span class="p">:</span><span class="w"> </span><span class="l">cloudalibaba-sentinel-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">groupId</span><span class="p">:</span><span class="w"> </span><span class="l">DEFAULT_GROUP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">data-type</span><span class="p">:</span><span class="w"> </span><span class="l">json</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">rule-type</span><span class="p">:</span><span class="w"> </span><span class="l">flow</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">management</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">endpoints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">web</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exposure</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">feign</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sentinel</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 激活Sentinel对Feign的支持</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>添加Nacos业务规则配置</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/2401a6b2df715ee64f647da2f31e1eeb.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/2401a6b2df715ee64f647da2f31e1eeb.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/2401a6b2df715ee64f647da2f31e1eeb.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/2401a6b2df715ee64f647da2f31e1eeb.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/2401a6b2df715ee64f647da2f31e1eeb.png"
        title="2401a6b2df715ee64f647da2f31e1eeb" /></p>
<p>配置内容解析</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;resource&#34;</span><span class="p">:</span> <span class="s2">&#34;/rateLimit/byUrl&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;IimitApp&#34;</span><span class="p">:</span> <span class="s2">&#34;default&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;grade&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;count&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;strategy&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;controlBehavior&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;clusterMode&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">}]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>resource：资源名称；</li>
<li>limitApp：来源应用；</li>
<li>grade：阈值类型，0表示线程数, 1表示QPS；</li>
<li>count：单机阈值；</li>
<li>strategy：流控模式，0表示直接，1表示关联，2表示链路；</li>
<li>controlBehavior：流控效果，0表示快速失败，1表示Warm Up，2表示排队等待；</li>
<li>clusterMode：是否集群。</li>
</ul>
<p>启动8401后刷新sentinel发现业务规则有了</p>
<p>快速访问测试接口 - localhost:8401/rateLimit/byUrl - 页面返回Blocked by Sentinel (flow limiting)</p>
<p>停止8401再看sentinel - 停机后发现流控规则没有了</p>
<p>重新启动8401再看sentinel</p>
<ul>
<li>乍一看还是没有，稍等一会儿</li>
<li>多次调用 - localhost:8401/rateLimit/byUrl</li>
<li>重新配置出现了，持久化验证通过</li>
</ul>
<h2 id="gateway-网关">Gateway 网关</h2>
<p>三大核心概念</p>
<ul>
<li>Route(路由) - 路由是构建网关的基本模块,它由ID,目标URI,一系列的断言和过滤器组成,如断言为true则匹配该路由；</li>
<li>Predicate(断言) - 参考的是Java8的java.util.function.Predicate，开发人员可以匹配HTTP请求中的所有内容(例如请求头或请求参数),如果请求与断言相匹配则进行路由；</li>
<li>Filter(过滤) - 指的是Spring框架中GatewayFilter的实例,使用过滤器,可以在请求被路由前或者之后对请求进行修改。</li>
</ul>
<h3 id="模块搭建">模块搭建</h3>
<ol>
<li>
<p>新建模块</p>
</li>
<li>
<p>pom</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">        <span class="c">&lt;!--gateway网关--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-gateway<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--nacos客户端--&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">server</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api-gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="l">localhost:8848</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">gateway</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">locator</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 让gateway可以发现nacos中的微服务</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>启动类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootApplication</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableDiscoveryClient</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiGatewayServer</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">ApiGatewayServer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">http://ip地址:端口号/服务名/请求
</span></span><span class="line"><span class="cl">例如：
</span></span><span class="line"><span class="cl">localhost:9000/order-service/sentinel2
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="路由">路由</h3>
<p>默认情况下Gateway会根据注册中心注册的服务列表，以注册中心上微服务名为路径创建<strong>动态路由进行转发，从而实现动态路由的功能</strong>（不写死一个地址）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api-gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="l">localhost:8848</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">gateway</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">locator</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 让gateway可以发现nacos中的微服务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">product_route</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">lb://product-service </span><span class="w"> </span><span class="c">#匹配后提供服务的路由地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">predicates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">Path=/product-serv/**</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">filters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">StripPrefix=1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">order_route</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">lb://order-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">predicates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">Path=/order-serv/**</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">filters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">StripPrefix=1</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="断言">断言</h3>
<blockquote>
<p>常用的Route Predicate Factory</p>
<p>The After Route Predicate Factory
The Before Route Predicate Factory
The Between Route Predicate Factory
The Cookie Route Predicate Factory
The Header Route Predicate Factory
The Host Route Predicate Factory
The Method Route Predicate Factory
The Path Route Predicate Factory
The Query Route Predicate Factory
The RemoteAddr Route Predicate Factory
The weight Route Predicate Factory</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yml" data-lang="yml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">api-gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nacos</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">server-addr</span><span class="p">:</span><span class="w"> </span><span class="l">localhost:8848</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">gateway</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">locator</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 让gateway可以发现nacos中的微服务</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">routes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l">product_route</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l">lb://product-service </span><span class="w"> </span><span class="c">#匹配后提供服务的路由地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          
</span></span></span><span class="line"><span class="cl"><span class="w">          
</span></span></span><span class="line"><span class="cl"><span class="w">          
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">predicates</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#            - Header=X-Request-Id, \d+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#            - Cookie=username,zzyy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c">#            - After=2021-05-16T19:53:59.024+08:00[Asia/Shanghai]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span>- <span class="l">Path=/product-serv/** </span><span class="w"> </span><span class="c"># 断言，路径相匹配的进行路由</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">filters</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="l">StripPrefix=1       </span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="过滤">过滤</h3>
<blockquote>
<p>StripPrefix=1    去除第一段路由</p>
</blockquote>
<h4 id="自定义局部过滤器">自定义局部过滤器</h4>
<blockquote>
<p>注意：</p>
<ul>
<li>命名：xxxGatewayFilterFactory          使用：- xxx=</li>
<li>参数顺序</li>
</ul>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TimeGatewayFilterFactory</span> <span class="kd">extends</span> <span class="n">AbstractGatewayFilterFactory</span><span class="o">&lt;</span><span class="n">TimeGatewayFilterFactory</span><span class="o">.</span><span class="na">Config</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">BEGIN_TIME</span> <span class="o">=</span> <span class="s">&#34;beginTime&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//构造函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="nf">TimeGatewayFilterFactory</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">super</span><span class="o">(</span><span class="n">TimeGatewayFilterFactory</span><span class="o">.</span><span class="na">Config</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//读取配置文件中的参数 赋值到 配置类中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">shortcutFieldOrder</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&#34;show&#34;</span><span class="o">,</span><span class="s">&#34;count&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">GatewayFilter</span> <span class="nf">apply</span><span class="o">(</span><span class="n">Config</span> <span class="n">config</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">GatewayFilter</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">            <span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">filter</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="o">(!</span><span class="n">config</span><span class="o">.</span><span class="na">show</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">exchange</span><span class="o">.</span><span class="na">getAttributes</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="n">BEGIN_TIME</span><span class="o">,</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">                 *  pre的逻辑
</span></span></span><span class="line"><span class="cl"><span class="cm">                 * chain.filter().then(Mono.fromRunable(()-&gt;{
</span></span></span><span class="line"><span class="cl"><span class="cm">                 *     post的逻辑
</span></span></span><span class="line"><span class="cl"><span class="cm">                 * }))
</span></span></span><span class="line"><span class="cl"><span class="cm">                 */</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">).</span><span class="na">then</span><span class="o">(</span><span class="n">Mono</span><span class="o">.</span><span class="na">fromRunnable</span><span class="o">(()-&gt;{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="n">BEGIN_TIME</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="o">(</span><span class="n">startTime</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">getURI</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;请求耗时: &#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">)</span> <span class="o">+</span> <span class="s">&#34;ms&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="o">}</span>
</span></span><span class="line"><span class="cl">                <span class="o">}));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">};</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Setter</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Getter</span>
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Config</span><span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">show</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="全局过滤器">全局过滤器</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthGlobalFilter</span> <span class="kd">implements</span> <span class="n">GlobalFilter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">filter</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">exchange</span><span class="o">,</span> <span class="n">GatewayFilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">getQueryParams</span><span class="o">().</span><span class="na">getFirst</span><span class="o">(</span><span class="s">&#34;token&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">token</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;鉴权失败&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">exchange</span><span class="o">.</span><span class="na">getResponse</span><span class="o">().</span><span class="na">setStatusCode</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">UNAUTHORIZED</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">exchange</span><span class="o">.</span><span class="na">getResponse</span><span class="o">().</span><span class="na">setComplete</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">exchange</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="集成sentinel实现网关限流">集成Sentinel实现网关限流</h3>
<p>网关是所有请求的公共入口，所以可以在网关进行限流，而且限流的方式也很多，我们本次采用前</p>
<p>面学过的Sentinel组件来实现网关的限流。Sentinel支持对SpringCloud Gateway、Zuul等主流网关进</p>
<p>行限流。</p>
<p>从1.6.0版本开始，Sentinel提供了SpringCloud Gateway的适配模块，可以提供两种资源维度的限流：</p>
<ul>
<li>
<p>route维度：即在Spring配置文件中配置的路由条目，资源名为对应的routeId</p>
</li>
<li>
<p>自定义API维度：用户可以利用Sentinel提供的API来自定义一些API分组</p>
</li>
</ul>
<h4 id="网关集成sentinel">网关集成Sentinel</h4>
<p><a href="https://github.com/alibaba/Sentinel/wiki/" target="_blank" rel="noopener noreffer ">https://github.com/alibaba/Sentinel/wiki/</a>网关限流</p>
<ol>
<li>
<p>添加依赖</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;groupId&gt;</span>com.alibaba.csp<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;artifactId&gt;</span>sentinel-spring-cloud-gateway-adapter<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>编写配置类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">cn.wolfcode.config</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GatewayConfiguration</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ViewResolver</span><span class="o">&gt;</span> <span class="n">viewResolvers</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ServerCodecConfigurer</span> <span class="n">serverCodecConfigurer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">GatewayConfiguration</span><span class="o">(</span><span class="n">ObjectProvider</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ViewResolver</span><span class="o">&gt;&gt;</span> <span class="n">viewResolversProvider</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                                <span class="n">ServerCodecConfigurer</span> <span class="n">serverCodecConfigurer</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">viewResolvers</span> <span class="o">=</span> <span class="n">viewResolversProvider</span><span class="o">.</span><span class="na">getIfAvailable</span><span class="o">(</span><span class="n">Collections</span><span class="o">::</span><span class="n">emptyList</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">serverCodecConfigurer</span> <span class="o">=</span> <span class="n">serverCodecConfigurer</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 配置限流的异常处理器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Order</span><span class="o">(</span><span class="n">Ordered</span><span class="o">.</span><span class="na">HIGHEST_PRECEDENCE</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">SentinelGatewayBlockExceptionHandler</span> <span class="nf">sentinelGatewayBlockExceptionHandler</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Register the block exception handler for Spring Cloud Gateway.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="k">new</span> <span class="n">SentinelGatewayBlockExceptionHandler</span><span class="o">(</span><span class="n">viewResolvers</span><span class="o">,</span> <span class="n">serverCodecConfigurer</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 初始化一个限流的过滤器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Order</span><span class="o">(</span><span class="n">Ordered</span><span class="o">.</span><span class="na">HIGHEST_PRECEDENCE</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">GlobalFilter</span> <span class="nf">sentinelGatewayFilter</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">SentinelGatewayFilter</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//增加对商品微服务的 限流
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="nd">@PostConstruct</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">initGatewayRules</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Set</span><span class="o">&lt;</span><span class="n">GatewayFlowRule</span><span class="o">&gt;</span> <span class="n">rules</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">rules</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">GatewayFlowRule</span><span class="o">(</span><span class="s">&#34;product_route&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">setCount</span><span class="o">(</span><span class="n">3</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">setIntervalSec</span><span class="o">(</span><span class="n">1</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">GatewayRuleManager</span><span class="o">.</span><span class="na">loadRules</span><span class="o">(</span><span class="n">rules</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>重启网关服务并测试.</p>
</li>
</ol>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030175846125.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030175846125.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030175846125.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030175846125.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030175846125.png"
        title="image-20201030175846125" /></strong></p>
<h4 id="修改限流默认返回格式">修改限流默认返回格式</h4>
<ol>
<li>
<p>在配置类GatewayConfiguration.java中添加如下配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@PostConstruct</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">initBlockHandlers</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">BlockRequestHandler</span> <span class="n">blockRequestHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BlockRequestHandler</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">public</span> <span class="n">Mono</span><span class="o">&lt;</span><span class="n">ServerResponse</span><span class="o">&gt;</span> <span class="nf">handleRequest</span><span class="o">(</span><span class="n">ServerWebExchange</span> <span class="n">serverWebExchange</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Map</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">		<span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;code&#34;</span><span class="o">,</span> <span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;message&#34;</span><span class="o">,</span> <span class="s">&#34;接口被限流了&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="n">ServerResponse</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">).</span>
</span></span><span class="line"><span class="cl">				<span class="n">contentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">).</span>
</span></span><span class="line"><span class="cl">				<span class="n">body</span><span class="o">(</span><span class="n">BodyInserters</span><span class="o">.</span><span class="na">fromValue</span><span class="o">(</span><span class="n">map</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">GatewayCallbackManager</span><span class="o">.</span><span class="na">setBlockHandler</span><span class="o">(</span><span class="n">blockRequestHandler</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>重启并测试</p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030180400822.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030180400822.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030180400822.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030180400822.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201030180400822.png"
        title="image-20201030180400822" /></strong></p>
</li>
</ol>
<h4 id="自定义api分组">自定义API分组</h4>
<p>自定义API分组是一种更细粒度的限流规则定义</p>
<ol>
<li>
<p>在shop-order-server项目中添加ApiController</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">cn.wolfcode.controller</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/api&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApiController</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">&#34;/hello&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">api1</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;api&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>重启shop-order-server项目.</p>
</li>
<li>
<p>在api-gateway项目的配置GatewayConfiguration.java中添加如下配置:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@PostConstruct</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">initCustomizedApis</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Set</span><span class="o">&lt;</span><span class="n">ApiDefinition</span><span class="o">&gt;</span> <span class="n">definitions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">	<span class="n">ApiDefinition</span> <span class="n">api1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ApiDefinition</span><span class="o">(</span><span class="s">&#34;order_api&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">setPredicateItems</span><span class="o">(</span><span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">ApiPredicateItem</span><span class="o">&gt;()</span> <span class="o">{{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">add</span><span class="o">(</span><span class="k">new</span> <span class="n">ApiPathPredicateItem</span><span class="o">().</span><span class="na">setPattern</span><span class="o">(</span><span class="s">&#34;/order-serv/api/**&#34;</span><span class="o">).</span>                 <span class="n">setMatchStrategy</span><span class="o">(</span><span class="n">SentinelGatewayConstants</span><span class="o">.</span><span class="na">URL_MATCH_STRATEGY_PREFIX</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                <span class="o">}});</span>
</span></span><span class="line"><span class="cl">	<span class="n">definitions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">api1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">GatewayApiDefinitionManager</span><span class="o">.</span><span class="na">loadApiDefinitions</span><span class="o">(</span><span class="n">definitions</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="nd">@PostConstruct</span>
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">initGatewayRules</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Set</span><span class="o">&lt;</span><span class="n">GatewayFlowRule</span><span class="o">&gt;</span> <span class="n">rules</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">	<span class="n">rules</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">GatewayFlowRule</span><span class="o">(</span><span class="s">&#34;product_route&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">setCount</span><span class="o">(</span><span class="n">3</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">setIntervalSec</span><span class="o">(</span><span class="n">1</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">rules</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">GatewayFlowRule</span><span class="o">(</span><span class="s">&#34;order_api&#34;</span><span class="o">).</span>
</span></span><span class="line"><span class="cl">                <span class="n">setCount</span><span class="o">(</span><span class="n">1</span><span class="o">).</span>
</span></span><span class="line"><span class="cl">                <span class="n">setIntervalSec</span><span class="o">(</span><span class="n">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">GatewayRuleManager</span><span class="o">.</span><span class="na">loadRules</span><span class="o">(</span><span class="n">rules</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>直接访问localhost:8091/api/hello 是不会发生限流的，访问localhost:9000/order-serv/api/hello 就会出现限流了.</p>
</li>
</ol>
<h2 id="sleuthzipkin-链路追踪">Sleuth+Zipkin 链路追踪</h2>
<h3 id="集成链路追踪组件sleuth">集成链路追踪组件Sleuth</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-sleuth<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="zipkinsleuth整合">Zipkin+Sleuth整合</h3>
<ol>
<li>
<p>下载Zipkin的jar包，在官网可以下载.</p>
</li>
<li>
<p>通过命令行，输入下面的命令启动ZipKin Server</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">java -jar zipkin-server-2.22.1-exec.jar
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>通过浏览器访问 localhost:9411访问</p>
</li>
<li>
<p>添加依赖</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-zipkin<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">zipkin</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">base-url</span><span class="p">:</span><span class="w"> </span><span class="l">http://127.0.0.1:9411/</span><span class="w"> </span><span class="c">#zipkin server的请求地址</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">discoveryClientEnabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c">#让nacos把它当成一个URL，而不要当做服务名</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">sleuth</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">sampler</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">probability</span><span class="p">:</span><span class="w"> </span><span class="m">1.0</span><span class="w"> </span><span class="c">#采样的百分比</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>调用接口后访问 localhost:9411查看</p>
</li>
</ol>
<h2 id="分布式调度">分布式调度</h2>
<h3 id="elastic-job">Elastic-Job</h3>
<h4 id="搭建-1">搭建</h4>
<blockquote>
<p>需要zooker</p>
</blockquote>
<ol>
<li>
<p>pom</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>com.dangdang<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>elastic-job-lite-spring<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>2.1.5<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>yaml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">elasticjob</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">zookeeper-url</span><span class="p">:</span><span class="w"> </span><span class="l">localhost:2181</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">group-name</span><span class="p">:</span><span class="w"> </span><span class="l">elastic-job-group</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>注册中心配置类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RegistryCenterConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span><span class="o">(</span><span class="n">initMethod</span> <span class="o">=</span> <span class="s">&#34;init&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">CoordinatorRegistryCenter</span> <span class="nf">createRegistryCenter</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${elasticjob.zookeeper-url}&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">zookeeperUrl</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${elasticjob.group-name}&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">groupName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//zk的配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ZookeeperConfiguration</span> <span class="n">zookeeperConfiguration</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ZookeeperConfiguration</span><span class="o">(</span><span class="n">zookeeperUrl</span><span class="o">,</span> <span class="n">groupName</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//设置zk超时时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">zookeeperConfiguration</span><span class="o">.</span><span class="na">setSessionTimeoutMilliseconds</span><span class="o">(</span><span class="n">100</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建注册中心
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="k">new</span> <span class="n">ZookeeperRegistryCenter</span><span class="o">(</span><span class="n">zookeeperConfiguration</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>任务调度抽取公共方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ElasticJobLite</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">LiteJobConfiguration</span> <span class="nf">createJobConfiguration</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//具体类
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">ElasticJob</span><span class="o">&gt;</span> <span class="n">jobClass</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//cron表达式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kd">final</span> <span class="n">String</span> <span class="n">cron</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//分片数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kd">final</span> <span class="kt">int</span> <span class="n">shardingTotalCount</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//分片表达式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kd">final</span> <span class="n">String</span> <span class="n">shardingItemParameters</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//job类型 DataflowJob[true] SimpleJob[false]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="kt">boolean</span> <span class="n">dataflowType</span>
</span></span><span class="line"><span class="cl">    <span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 定义作业核心配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">JobCoreConfiguration</span><span class="o">.</span><span class="na">Builder</span> <span class="n">jobCoreConfigurationBuilder</span> <span class="o">=</span> <span class="n">JobCoreConfiguration</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">(</span><span class="n">jobClass</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">cron</span><span class="o">,</span> <span class="n">shardingTotalCount</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//分片
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">shardingItemParameters</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">jobCoreConfigurationBuilder</span><span class="o">.</span><span class="na">shardingItemParameters</span><span class="o">(</span><span class="n">shardingItemParameters</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//初始化JobTypeConfiguration
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">JobTypeConfiguration</span> <span class="n">jobConfig</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//DataflowJob[true] SimpleJob[false]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">dataflowType</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//定义Dataflow类型配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">jobConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataflowJobConfiguration</span><span class="o">(</span><span class="n">jobCoreConfigurationBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(),</span> <span class="n">jobClass</span><span class="o">.</span><span class="na">getCanonicalName</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 定义SIMPLE类型配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">jobConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleJobConfiguration</span><span class="o">(</span><span class="n">jobCoreConfigurationBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(),</span> <span class="n">jobClass</span><span class="o">.</span><span class="na">getCanonicalName</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 定义Lite作业根配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">LiteJobConfiguration</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">(</span><span class="n">jobConfig</span><span class="o">).</span><span class="na">overwrite</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>任务类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyElasticJob</span> <span class="kd">implements</span> <span class="n">SimpleJob</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">ShardingContext</span> <span class="n">shardingContext</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;定时任务开始====&gt;&#34;</span><span class="o">+</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>配置使用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ElasticJobConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">CoordinatorRegistryCenter</span> <span class="n">registryCenter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span><span class="o">(</span><span class="n">initMethod</span> <span class="o">=</span> <span class="s">&#34;init&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">SpringJobScheduler</span> <span class="nf">initSimpleElasticJob</span><span class="o">(</span><span class="n">MyElasticJob</span> <span class="n">myElasticJob</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringJobScheduler</span> <span class="n">springJobScheduler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpringJobScheduler</span><span class="o">(</span><span class="n">myElasticJob</span><span class="o">,</span> <span class="n">registryCenter</span><span class="o">,</span> <span class="n">ElasticJobLite</span><span class="o">.</span><span class="na">createJobConfiguration</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">MyElasticJob</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;0/3 * * * * ?&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">1</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="kc">null</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="kc">false</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">springJobScheduler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h4 id="分片">分片</h4>
<p>​	作业分片是指任务的分布式执行，需要将一个任务拆分为多个独立的任务项，然后由分布式的应用实例分别执行某一个或者几个分布项。</p>
<p>​	例如：Elastic-Job快速入门中文件备份的案例，现有两台服务器，每台服务器分别跑一个应用实例。为了快速执行作业，那么可以讲任务分成4片，每个应用实例都执行两片。作业遍历数据逻辑应为：实例1查找text和image类型文件执行备份，实例2查找radio和vedio类型文件执行备份。如果由于服务器拓容应用实例数量增加为4，则作业遍历数据的逻辑应为: 4个实例分别处理text,image,radio,video类型的文件。</p>
<p>​	可以看到，通过对任务的合理分片化，从而达到任务并行处理的效果.</p>
<p><strong>分片项与业务处理解耦</strong></p>
<p>​	Elastic-Job并不直接提供数据处理的功能,框架只会将分片项分配至各个运行中的作业服务器，开发者需要自行处理分片项与真实数据的对应关系</p>
<p><strong>最大限度利用资源</strong></p>
<p>将分片项设置大于服务器的数据，最好是大于服务器倍数的数量，作业将会合理利用分布式资源，动态的分配分片项.</p>
<p>​	例如: 3台服务器，分成10片，则分片项结果为服务器A=0,1,2;服务器B=3,4,5;服务器C=6,7,8,9.如果   服务器C奔溃，则分片项分配结果为服务器A=0,1,2,3,4;服务器B=5,6,7,8,9.在不丢失分片项的情况下，最大限度利用现有的资源提高吞吐量.</p>
<blockquote>
<p>注：</p>
<ul>
<li>shardingContext.getShardingParameter() 获取分片信息</li>
</ul>
</blockquote>
<ol>
<li>
<p>job</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FileCustomElasticJob</span> <span class="kd">implements</span> <span class="n">SimpleJob</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">FileCustomMapper</span> <span class="n">fileCustomMapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">ShardingContext</span> <span class="n">shardingContext</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">doWork</span><span class="o">(</span><span class="n">shardingContext</span><span class="o">.</span><span class="na">getShardingParameter</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doWork</span><span class="o">(</span><span class="n">String</span> <span class="n">fileType</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">FileCustom</span><span class="o">&gt;</span> <span class="n">fileList</span> <span class="o">=</span> <span class="n">fileCustomMapper</span><span class="o">.</span><span class="na">selecByType</span><span class="o">(</span><span class="n">fileType</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;类型为:&#34;</span><span class="o">+</span><span class="n">fileType</span><span class="o">+</span><span class="s">&#34;,文件，需要备份个数:&#34;</span><span class="o">+</span><span class="n">fileList</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="o">(</span><span class="n">FileCustom</span> <span class="n">fileCustom</span><span class="o">:</span><span class="n">fileList</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">backUpFile</span><span class="o">(</span><span class="n">fileCustom</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">backUpFile</span><span class="o">(</span><span class="n">FileCustom</span> <span class="n">fileCustom</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//模拟备份动作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;执行文件备份====&gt;&#34;</span><span class="o">+</span><span class="n">fileCustom</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">fileCustomMapper</span><span class="o">.</span><span class="na">changeState</span><span class="o">(</span><span class="n">fileCustom</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ElasticJobConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">CoordinatorRegistryCenter</span> <span class="n">registryCenter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span><span class="o">(</span><span class="n">initMethod</span> <span class="o">=</span> <span class="s">&#34;init&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">SpringJobScheduler</span> <span class="nf">initFileCustomElasticJob</span><span class="o">(</span><span class="n">FileCustomElasticJob</span> <span class="n">fileCustomElasticJob</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringJobScheduler</span> <span class="n">springJobScheduler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpringJobScheduler</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">fileCustomElasticJob</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">registryCenter</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">ElasticJobLite</span><span class="o">.</span><span class="na">createJobConfiguration</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">FileCustomElasticJob</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;0 0/1 * * * ?&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">4</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;0=text,1=image,2=radio,3=vedio&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                        <span class="kc">false</span>
</span></span><span class="line"><span class="cl">                <span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">springJobScheduler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h4 id="dataflow类型调度任务">Dataflow类型调度任务</h4>
<blockquote>
<p>Dataflow类型的定时任务需要实现Dataflowjob接口，该接口提供2个方法供覆盖，分别用于抓取（fetchData）和处理（processData）数据，我们继续对例子进行改造。</p>
<p>Dataflow类型用于处理数据流，他和SimpleJob不同，它以数据流的方式执行，调用fetchData抓取数据，知道抓取不到数据才停止作业。</p>
</blockquote>
<ol>
<li>
<p>job</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FileDataflowJob</span> <span class="kd">implements</span> <span class="n">DataflowJob</span><span class="o">&lt;</span><span class="n">FileCustom</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">FileCustomMapper</span> <span class="n">fileCustomMapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">FileCustom</span><span class="o">&gt;</span> <span class="nf">fetchData</span><span class="o">(</span><span class="n">ShardingContext</span> <span class="n">shardingContext</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">FileCustom</span><span class="o">&gt;</span> <span class="n">fileCustoms</span> <span class="o">=</span> <span class="n">fileCustomMapper</span><span class="o">.</span><span class="na">fetchData</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;抓取时间:&#34;</span><span class="o">+</span><span class="k">new</span> <span class="n">Date</span><span class="o">()+</span><span class="s">&#34;,个数&#34;</span><span class="o">+</span><span class="n">fileCustoms</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">fileCustoms</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processData</span><span class="o">(</span><span class="n">ShardingContext</span> <span class="n">shardingContext</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">FileCustom</span><span class="o">&gt;</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//模拟备份动作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="o">(</span><span class="n">FileCustom</span> <span class="n">fileCustom</span><span class="o">:</span><span class="n">data</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">            <span class="n">backUpFile</span><span class="o">(</span><span class="n">fileCustom</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">backUpFile</span><span class="o">(</span><span class="n">FileCustom</span> <span class="n">fileCustom</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;执行文件备份====&gt;&#34;</span><span class="o">+</span><span class="n">fileCustom</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">fileCustomMapper</span><span class="o">.</span><span class="na">changeState</span><span class="o">(</span><span class="n">fileCustom</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span><span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ElasticJobConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">CoordinatorRegistryCenter</span> <span class="n">registryCenter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span><span class="o">(</span><span class="n">initMethod</span> <span class="o">=</span> <span class="s">&#34;init&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">SpringJobScheduler</span> <span class="nf">iniDataflowElasticJob</span><span class="o">(</span><span class="n">FileDataflowJob</span> <span class="n">fileDataflowJob</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringJobScheduler</span> <span class="n">springJobScheduler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpringJobScheduler</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">fileDataflowJob</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">registryCenter</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">ElasticJobLite</span><span class="o">.</span><span class="na">createJobConfiguration</span><span class="o">(</span><span class="n">FileDataflowJob</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&#34;0 0/1 * * * ?&#34;</span><span class="o">,</span> <span class="n">1</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        					<span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">springJobScheduler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h4 id="运维控制台">运维控制台</h4>
<h5 id="修改elastic-job配置类">修改Elastic-Job配置类</h5>
<p>在ElasticJobConfig配置类中注入DataSource</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ElasticJobConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">DataSource</span> <span class="n">dataSource</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">......</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在任务配置中增加事件追踪配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Bean</span><span class="o">(</span><span class="n">initMethod</span> <span class="o">=</span> <span class="s">&#34;init&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">SpringJobScheduler</span> <span class="nf">initFileCustomElasticJob</span><span class="o">(</span><span class="n">FileCustomElasticJob</span> <span class="n">fileCustomElasticJob</span><span class="o">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//增加任务事件追踪配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">JobEventConfiguration</span> <span class="n">jobEventConfiguration</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JobEventRdbConfiguration</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">SpringJobScheduler</span> <span class="n">springJobScheduler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SpringJobScheduler</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">fileCustomElasticJob</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">registryCenter</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">createJobConfiguration</span><span class="o">(</span><span class="n">FileCustomElasticJob</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="s">&#34;0 0/1 * * * ?&#34;</span><span class="o">,</span><span class="n">4</span><span class="o">,</span><span class="s">&#34;0=text,1=image,2=radio,3=vedio&#34;</span><span class="o">,</span><span class="kc">false</span><span class="o">),</span>
</span></span><span class="line"><span class="cl">                <span class="n">jobEventConfiguration</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">springJobScheduler</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="日志信息表">日志信息表</h5>
<p>启动后会发现在elastic-job-demo数据库中新增以下两张表</p>
<p><strong>job_execution_log</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588905075352.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588905075352.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588905075352.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588905075352.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588905075352.png"
        title="1588905075352" /></p>
<p>记录每次作业的执行历史，分为两个步骤：</p>
<p>1.作业开始执行时间向数据库插入数据.</p>
<p>2.作业完成执行时向数据库更新数据，更新is_success,complete_time和failure_cause(如果任务执行失败)</p>
<p><strong>job_status_trace_log</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588905091464.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588905091464.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588905091464.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588905091464.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588905091464.png"
        title="1588905091464" /></p>
<p>记录作业状态变更痕迹表，可通过每次作业运行的task_id查询作业状态变化的生命轨迹和运行轨迹.</p>
<h5 id="控制台搭建">控制台搭建</h5>
<p>elastic-job中提供了一个elastic-job-lite-console控制台</p>
<p><strong>设计理念</strong></p>
<p>1.本 控制台和Elastic-Job并无直接关系，是通过读取Elastic-Job的注册中心数据展示作业状态，或更新注册中心数据修改全局配置。</p>
<p>2.控制台只能控制任务本身是否运行，但不能控制作业进程的启停，因为控制台和作业本身服务器是完全分布式的，控制台并不能控制作业服务器。</p>
<p><strong>主要功能:</strong></p>
<p>1.查看作业以及服务器状态</p>
<p>2.快捷的修改以及删除作业配置</p>
<p>3.启用和禁用作业</p>
<p>4.跨注册中心查看作业</p>
<p>5.查看作业运行轨迹和运行状态</p>
<p><strong>不支持项</strong></p>
<p>1.添加作业，因为作业都是在首次运行时自动添加，使用控制台添加作业并无必要.直接在作业服务器启动包含Elasitc-Job的作业进程即可。</p>
<h6 id="搭建步骤">搭建步骤</h6>
<ul>
<li>
<p>解压缩<code>elastic-job-lite-console-2.1.5.tar</code></p>
</li>
<li>
<p>进入bin目录，并执行:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">bin\start.sh
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>打开浏览器访问<code>localhost:8899</code></p>
<p>用户名: root 密码: root,进入之后界面如下:</p>
</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588906482667.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588906482667.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588906482667.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588906482667.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588906482667.png"
        title="1588906482667" /></p>
<p>提供两种用户：管理员和访客，管理员拥有全部操作权限，访客仅拥有查看权限。默认管理员账号和面膜是root/root,访客用户名和密码是guest/guest,通过conf\auth.properties可以修改管理员以及访客用户名及密码</p>
<h6 id="配置及使用">配置及使用</h6>
<ul>
<li>
<p>配置注册中心地址</p>
<p>先启动zookeeper然后再注册中心配置界面，点添加</p>
</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588906867417.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588906867417.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588906867417.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588906867417.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588906867417.png"
        title="1588906867417" /></p>
<p>点击提交后，然后点连接（zookeeper必须处于启动状态）</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588906957795.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588906957795.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588906957795.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588906957795.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588906957795.png"
        title="1588906957795" /></p>
<p>连接成功后，在作业纬度下可以显示该命名空间作业名称，分片数量及该作业的cron表达式等信息</p>
<p>在服务器纬度可以查看到服务器ip,当前运行的是实例数，作业总数等信息。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588907089548.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588907089548.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588907089548.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588907089548.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588907089548.png"
        title="1588907089548" /></p>
<p>添加数据库连接之后可以查看任务的执行结果</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588907583020.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588907583020.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588907583020.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588907583020.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588907583020.png"
        title="1588907583020" /></p>
<p>然后在作业历史中就可以看到任务执行历史了。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588907629648.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588907629648.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588907629648.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588907629648.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/1588907629648.png"
        title="1588907629648" /></p>
<h2 id="canal-数据同步">Canal 数据同步</h2>
<h3 id="原理">原理</h3>
<p>模仿mysql主从的slave</p>
<h3 id="准备">准备</h3>
<ul>
<li>
<p>对于自建 MySQL , 需要先开启 Binlog 写入功能，配置 binlog-format 为 ROW 模式，my.cnf 中配置如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[mysqld]
</span></span><span class="line"><span class="cl">log-bin=mysql-bin # 开启 binlog
</span></span><span class="line"><span class="cl">binlog-format=ROW # 选择 ROW 模式
</span></span><span class="line"><span class="cl">server_id=1 # 配置 MySQL replaction 需要定义，不要和 canal 的 slaveId 重复
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>注意：针对阿里云 RDS for MySQL , 默认打开了 binlog , 并且账号默认具有 binlog dump 权限 , 不需要任何权限或者 binlog 设置,可以直接跳过这一步</li>
</ul>
</li>
<li>
<p>授权 canal 链接 MySQL 账号具有作为 MySQL slave 的权限, 如果已有账户可直接 grant</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="n">canal</span><span class="w"> </span><span class="k">IDENTIFIED</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s1">&#39;Canal_2021&#39;</span><span class="p">;</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="p">,</span><span class="w"> </span><span class="n">REPLICATION</span><span class="w"> </span><span class="n">SLAVE</span><span class="p">,</span><span class="w"> </span><span class="n">REPLICATION</span><span class="w"> </span><span class="n">CLIENT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="o">*</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;canal&#39;</span><span class="o">@</span><span class="s1">&#39;%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- GRANT ALL PRIVILEGES ON *.* TO &#39;canal&#39;@&#39;%&#39; ;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">FLUSH</span><span class="w"> </span><span class="k">PRIVILEGES</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>重启mysql</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">//centos6
</span></span><span class="line"><span class="cl">service mysqld restart   
</span></span><span class="line"><span class="cl">//centos7
</span></span><span class="line"><span class="cl">systemctl restart mysqld
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="启动">启动</h3>
<ul>
<li>
<p>下载canal,我们使用的版本是1.1.4版本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">https://github.com/alibaba/canal/releases/tag/canal-1.1.4
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>解压缩</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mkdir /usr/local/canal
</span></span><span class="line"><span class="cl"> tar -zxvf software/canal.deployer-1.1.4.tar.gz -C /usr/local/canal/
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>解压完成后，进入 /tmp/canal 目录，可以看到如下结构</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">drwxr-xr-x 2 jianghang jianghang  136 2013-02-05 21:51 bin
</span></span><span class="line"><span class="cl">drwxr-xr-x 4 jianghang jianghang  160 2013-02-05 21:51 conf
</span></span><span class="line"><span class="cl">drwxr-xr-x 2 jianghang jianghang 1.3K 2013-02-05 21:51 lib
</span></span><span class="line"><span class="cl">drwxr-xr-x 2 jianghang jianghang   48 2013-02-05 21:29 logs
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li>
<p>配置修改</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">vi /usr/local/canal/conf/example/instance.properties
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">## mysql serverId
</span></span><span class="line"><span class="cl">canal.instance.mysql.slaveId = 1234
</span></span><span class="line"><span class="cl">#position info，需要改成自己的数据库信息
</span></span><span class="line"><span class="cl">canal.instance.master.address = 127.0.0.1:3306 
</span></span><span class="line"><span class="cl">canal.instance.master.journal.name = 
</span></span><span class="line"><span class="cl">canal.instance.master.position = 
</span></span><span class="line"><span class="cl">canal.instance.master.timestamp = 
</span></span><span class="line"><span class="cl">#canal.instance.standby.address = 
</span></span><span class="line"><span class="cl">#canal.instance.standby.journal.name =
</span></span><span class="line"><span class="cl">#canal.instance.standby.position = 
</span></span><span class="line"><span class="cl">#canal.instance.standby.timestamp = 
</span></span><span class="line"><span class="cl">#username/password，需要改成自己的数据库信息
</span></span><span class="line"><span class="cl">canal.instance.dbUsername = canal  
</span></span><span class="line"><span class="cl">canal.instance.dbPassword = canal
</span></span><span class="line"><span class="cl">canal.instance.defaultDatabaseName =
</span></span><span class="line"><span class="cl">canal.instance.connectionCharset = UTF-8
</span></span><span class="line"><span class="cl">#table regex
</span></span><span class="line"><span class="cl">canal.instance.filter.regex = .\*\\\\..\*
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>canal.instance.connectionCharset 代表数据库的编码方式对应到 java 中的编码类型，比如 UTF-8，GBK , ISO-8859-1</li>
<li>如果系统是1个 cpu，需要将 canal.instance.parser.parallel 设置为 false</li>
</ul>
</li>
<li>
<p>启动</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sh /usr/local/canal/bin/startup.sh
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>查看 server 日志</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">tail -f -n <span class="m">50</span> logs/canal/canal.log
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">2013-02-05 22:45:27.967 [main] INFO  com.alibaba.otter.canal.deployer.CanalLauncher - ## start the canal server.
</span></span><span class="line"><span class="cl">2013-02-05 22:45:28.113 [main] INFO  com.alibaba.otter.canal.deployer.CanalController - ## start the canal server[10.1.29.120:11111]
</span></span><span class="line"><span class="cl">2013-02-05 22:45:28.210 [main] INFO  com.alibaba.otter.canal.deployer.CanalLauncher - ## the canal server is running now ......
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>查看 instance 的日志</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">tail -f -n 50 logs/example/example.log
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">2013-02-05 22:50:45.636 [main] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [canal.properties]
</span></span><span class="line"><span class="cl">2013-02-05 22:50:45.641 [main] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [example/instance.properties]
</span></span><span class="line"><span class="cl">2013-02-05 22:50:45.803 [main] INFO  c.a.otter.canal.instance.spring.CanalInstanceWithSpring - start CannalInstance for 1-example 
</span></span><span class="line"><span class="cl">2013-02-05 22:50:45.810 [main] INFO  c.a.otter.canal.instance.spring.CanalInstanceWithSpring - start successful....
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>关闭</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sh /usr/local/canal/bin/stop.sh
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">不能用 kill -9 进程 
</span></span><span class="line"><span class="cl">如果杀了, 需要删除 canal.pid 再次启动,就可以了
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="sh脚本">sh脚本</h3>
<ul>
<li>
<p>starCanal.sh</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># !/bin/bash
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">echo &#39;------------------canal-starter-------------------------&#39; 
</span></span><span class="line"><span class="cl">sh /usr/local/canal/bin/startup.sh
</span></span><span class="line"><span class="cl">echo &#39;------------------canal-started-------------------------&#39;
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>shutdownCanal.sh</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># !/bin/bash
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">echo &#39;------------------canal-shutdown-------------------------&#39; 
</span></span><span class="line"><span class="cl">sh /usr/local/canal/bin/stop.sh
</span></span><span class="line"><span class="cl">echo &#39;------------------canal-shutdowned-------------------------&#39;
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="集成">集成</h3>
<p>1.首先启动Canal Server，具体部署参考给的文档</p>
<p>2.添加依赖</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;groupId&gt;</span>top.javatool<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;artifactId&gt;</span>canal-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="nt">&lt;version&gt;</span>1.2.1-RELEASE<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>3.添加配置如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">canal</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l">Canal服务部署的地址:11111</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">destination</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">logging</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">level</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">root</span><span class="p">:</span><span class="w"> </span><span class="l">info</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">top</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">javatool</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">canal</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">AbstractCanalClient</span><span class="p">:</span><span class="w"> </span><span class="l">error</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>4.添加Handler</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Slf4j</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Component</span>
</span></span><span class="line"><span class="cl"><span class="nd">@CanalTable</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;t_order_info&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderaInfoHandler</span> <span class="kd">implements</span> <span class="n">EntryHandler</span><span class="o">&lt;</span><span class="n">OrderInfo</span><span class="o">&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">StringRedisTemplate</span> <span class="n">redisTemplate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">insert</span><span class="o">(</span> <span class="n">OrderInfo</span> <span class="n">orderInfo</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;当有数据插入的时候会触发这个方法&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="n">OrderInfo</span> <span class="n">before</span><span class="o">,</span> <span class="n">OrderInfo</span> <span class="n">after</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;当有数据更新的时候会触发这个方法&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">delete</span><span class="o">(</span><span class="n">OrderInfo</span> <span class="n">orderInfo</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;当有数据删除的时候会触发这个方法&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>实体类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nn">cn.wolfcode.domain</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">lombok.Getter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">lombok.Setter</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">lombok.ToString</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.persistence.Column</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">javax.persistence.Table</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.math.BigDecimal</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Setter</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Getter</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;t_order_info&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@ToString</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderInfo</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Integer</span> <span class="n">STATUS_ARREARAGE</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span><span class="c1">//未付款
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Integer</span> <span class="n">STATUS_ACCOUNT_PAID</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span><span class="c1">//已付款
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Integer</span> <span class="n">STATUS_CANCEL</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span><span class="c1">//手动取消订单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Integer</span> <span class="n">STATUS_TIMEOUT</span> <span class="o">=</span> <span class="n">3</span><span class="o">;</span><span class="c1">//超时取消订单
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Integer</span> <span class="n">STATUS_REFUND</span> <span class="o">=</span> <span class="n">4</span><span class="o">;</span><span class="c1">//已退款
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Integer</span> <span class="n">PAYTYPE_ONLINE</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span><span class="c1">//在线支付
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Integer</span> <span class="n">PAYTYPE_INTERGRAL</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span><span class="c1">//积分支付
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;order_no&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">orderNo</span><span class="o">;</span><span class="c1">//订单编号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;user_id&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Long</span> <span class="n">userId</span><span class="o">;</span><span class="c1">//用户ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;product_id&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Long</span> <span class="n">productId</span><span class="o">;</span><span class="c1">//商品ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;product_name&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">productName</span><span class="o">;</span><span class="c1">//商品名称
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;product_img&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">productImg</span><span class="o">;</span><span class="c1">//商品图片
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;product_count&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">productCount</span><span class="o">;</span><span class="c1">//商品总数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;product_price&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">productPrice</span><span class="o">;</span><span class="c1">//商品原价
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;seckill_price&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">BigDecimal</span> <span class="n">seckillPrice</span><span class="o">;</span><span class="c1">//秒杀价格
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;intergral&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Long</span> <span class="n">intergral</span><span class="o">;</span><span class="c1">//消耗积分
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;status&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_ARREARAGE</span><span class="o">;</span><span class="c1">//订单状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;create_date&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Date</span> <span class="n">createDate</span><span class="o">;</span><span class="c1">//订单创建时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;seckill_date&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Date</span> <span class="n">seckillDate</span><span class="o">;</span><span class="c1">//秒杀的日期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;seckill_time&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">seckillTime</span><span class="o">;</span><span class="c1">// 秒杀场次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;seckill_id&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Long</span> <span class="n">seckillId</span><span class="o">;</span><span class="c1">//秒杀商品ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="seata分布式事务">Seata分布式事务</h2>
<h3 id="seata-at">Seata-At</h3>
<p><strong>Seata主要由三个重要组件组成：</strong></p>
<ul>
<li>TC：Transaction Coordinator 事务协调器，管理全局的分支事务的状态，用于全局性事务的提交</li>
</ul>
<p>和回滚。</p>
<ul>
<li>
<p>TM：Transaction Manager 事务管理器，用于开启、提交或者回滚全局事务。</p>
</li>
<li>
<p>RM：Resource Manager 资源管理器，用于分支事务上的资源管理，向TC注册分支事务，上报分</p>
</li>
</ul>
<p>支事务的状态，接受TC的命令来提交或者回滚分支事务。</p>
<p><strong>举例</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2021-09-26%2019.06.51.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2021-09-26%2019.06.51.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2021-09-26%2019.06.51.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2021-09-26%2019.06.51.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2021-09-26%2019.06.51.png"
        title="截屏2021-09-26 19.06.51" /></p>
<p><strong>程序中</strong></p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201211151226068.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201211151226068.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201211151226068.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201211151226068.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201211151226068.png"
        title="image-20201211151226068" /></strong></p>
<p><strong>Seata-AT模式的执行流程如下:</strong></p>
<ol>
<li>
<p>A服务的TM向TC申请开启一个全局事务，TC就会创建一个全局事务并返回一个唯一的XID</p>
</li>
<li>
<p>A服务的RM向TC注册分支事务，并及其纳入XID对应全局事务的管辖</p>
</li>
<li>
<p>A服务执行分支事务，向数据库做操作4. A服务开始远程调用B服务，此时XID会在微服务的调用链上传播</p>
</li>
<li>
<p>B服务的RM向TC注册分支事务，并将其纳入XID对应的全局事务的管辖</p>
</li>
<li>
<p>B服务执行分支事务，向数据库做操作</p>
</li>
<li>
<p>全局事务调用链处理完毕，TM根据有无异常向TC发起全局事务的提交或者回滚</p>
</li>
<li>
<p>TC协调其管辖之下的所有分支事务， 决定是否回滚</p>
</li>
</ol>
<p><strong>Seata-AT模式实现2PC与传统2PC的差别</strong>：</p>
<ol>
<li>
<p>架构层次方面，传统2PC方案的 RM 实际上是在数据库层，RM本质上就是数据库自身，通过XA协议实现，而 Seata的RM是以jar包的形式作为中间件层部署在应用程序这一侧的。</p>
</li>
<li>
<p>两阶段提交方面，传统2PC无论第二阶段的决议是commit还是rollback，事务性资源的锁都要保持到Phase2完成才释放。而Seata的做法是在Phase1 就将本地事务提交，这样就可以省去Phase2持锁的时间，整体提高效率。</p>
</li>
</ol>
<h4 id="at模式代码实现">AT模式代码实现</h4>
<p>分布式事务发起方只需要贴<code>@GlobalTransactional</code>注解即可</p>
<p>分支分布式事务贴上<code>@Transactional</code>即可</p>
<h5 id="发起方">发起方</h5>
<blockquote>
<p>如果是远程调用需要判断<strong>返回值(关注是否做了统一异常处理以及统一返回类型)<strong>或者</strong>降级</strong>抛出异常</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * show 订单积分支付
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param orderNo 订单号
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return 提示信息
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GlobalTransactional</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Transactional</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">doIntergral</span><span class="o">(</span><span class="n">String</span> <span class="n">orderNo</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//1.通过orderInfo 查询订单信息 从mysql中查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">OrderInfo</span> <span class="n">orderInfo</span> <span class="o">=</span> <span class="n">orderInfoMapper</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">orderNo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//2.修改订单状态为已支付,支付类型为积分支付
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">orderInfoMapper</span><span class="o">.</span><span class="na">changePayStatus</span><span class="o">(</span><span class="n">orderNo</span><span class="o">,</span> <span class="n">OrderInfo</span><span class="o">.</span><span class="na">STATUS_ACCOUNT_PAID</span><span class="o">,</span> <span class="n">OrderInfo</span><span class="o">.</span><span class="na">PAYTYPE_INTERGRAL</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//3.远程调用积分服务，修改用户的积分(减积分)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">OperateIntergralVo</span> <span class="n">vo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OperateIntergralVo</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">vo</span><span class="o">.</span><span class="na">setPk</span><span class="o">(</span><span class="n">orderNo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">vo</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">.</span><span class="na">getIntergral</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">vo</span><span class="o">.</span><span class="na">setInfo</span><span class="o">(</span><span class="s">&#34;积分消费&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">vo</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">stringResult</span> <span class="o">=</span> <span class="n">intergralFeign</span><span class="o">.</span><span class="na">remoteIntergralPay</span><span class="o">(</span><span class="n">vo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//远程失败两种情况
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//1 远程发生异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//2 远程服务宕机，服务降级
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">stringResult</span><span class="o">.</span><span class="na">getCode</span><span class="o">()</span> <span class="o">==</span> <span class="n">500000</span> <span class="o">||</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">stringResult</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;远程异常&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="n">SeckillCodeMsg</span><span class="o">.</span><span class="na">INTERGRAL_SERVER_ERROR</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;远程异常没判断出来&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//4.支付日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">PayLog</span> <span class="n">payLog</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PayLog</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">payLog</span><span class="o">.</span><span class="na">setTradeNo</span><span class="o">(</span><span class="n">orderNo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">payLog</span><span class="o">.</span><span class="na">setOutTradeNo</span><span class="o">(</span><span class="n">orderNo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">SimpleDateFormat</span> <span class="n">simpleDateFormat</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s">&#34;yyyy-MM-dd HH:mm:ss:SSS&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">payLog</span><span class="o">.</span><span class="na">setNotifyTime</span><span class="o">(</span><span class="n">simpleDateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="n">payLog</span><span class="o">.</span><span class="na">setTotalAmount</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">.</span><span class="na">getIntergral</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">payLog</span><span class="o">.</span><span class="na">setPayType</span><span class="o">(</span><span class="n">OrderInfo</span><span class="o">.</span><span class="na">PAYTYPE_INTERGRAL</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">payLogMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">payLog</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;积分支付成功&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="分支">分支</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Transactional</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">intergralPay</span><span class="o">(</span><span class="n">OperateIntergralVo</span> <span class="n">vo</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//1.添加日志 实现幂等性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AccountLog</span> <span class="n">accountLog</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AccountLog</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">accountLog</span><span class="o">.</span><span class="na">setPkValue</span><span class="o">(</span><span class="n">vo</span><span class="o">.</span><span class="na">getPk</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">accountLog</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="n">AccountLog</span><span class="o">.</span><span class="na">TYPE_DECR</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">accountLog</span><span class="o">.</span><span class="na">setAmount</span><span class="o">(</span><span class="n">vo</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">accountLog</span><span class="o">.</span><span class="na">setGmtTime</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">accountLog</span><span class="o">.</span><span class="na">setInfo</span><span class="o">(</span><span class="n">vo</span><span class="o">.</span><span class="na">getInfo</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">accountLogMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">accountLog</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//        int a = 1/0; 模拟异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//2.修改积分
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">usableIntegralMapper</span><span class="o">.</span><span class="na">addIntergral</span><span class="o">(</span><span class="n">vo</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(),</span> <span class="o">-</span><span class="n">vo</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="seata-tcc">Seata-TCC</h3>
<h4 id="tcc模型图">TCC模型图</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201211153516323.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201211153516323.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201211153516323.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201211153516323.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201211153516323.png"
        title="image-20201211153516323" /></p>
<h4 id="异常处理">异常处理</h4>
<h5 id="空回滚">空回滚</h5>
<p>Try方法未执行,Cancel执行了</p>
<p><strong>出现原因:</strong></p>
<ol>
<li>Try超时</li>
<li>分布式事务回滚，触发Cancel</li>
</ol>
<p>解决方案: Cancel方法需要识别出是否执行Try方法,如果执行了就正常执行Cancel,如果没有就直接结束</p>
<p>增加事务日志表来实现这个功能.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">account_transaction</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">tx_id</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;事务Txid&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">action_id</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;分支事务id&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">gmt_create</span><span class="o">`</span><span class="w"> </span><span class="n">datetime</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;创建时间&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">gmt_modified</span><span class="o">`</span><span class="w"> </span><span class="n">datetime</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;修改时间&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">user_id</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;账户Uid&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">amount</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;变动金额&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="k">type</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;变动类型&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">tx_id</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">action_id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="幂等">幂等</h5>
<p>多次调用二阶段方法</p>
<p><strong>出现原因:</strong></p>
<ul>
<li>网络异常</li>
<li>分支事务所在服务器宕机</li>
</ul>
<p>解决方案: 做幂等性处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">account_transaction</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">tx_id</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;事务Txid&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">action_id</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;分支事务id&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">gmt_create</span><span class="o">`</span><span class="w"> </span><span class="n">datetime</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;创建时间&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">gmt_modified</span><span class="o">`</span><span class="w"> </span><span class="n">datetime</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;修改时间&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">user_id</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;账户Uid&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">amount</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;变动金额&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="k">type</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;变动类型&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="k">state</span><span class="o">`</span><span class="w"> </span><span class="nb">smallint</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">COMMENT</span><span class="w"> </span><span class="s1">&#39;状态: 1.初始化 2.已提交 3.已回滚&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">tx_id</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">action_id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="防悬挂">防悬挂</h5>
<p>Cancel比Try先执行</p>
<p>出现原因:</p>
<ol>
<li>Try超时(拥堵)</li>
<li>分布式事务回滚触发Cancel</li>
</ol>
<p>要允许空回滚，但是要拒绝空回滚之后的Try方法.</p>
<p>解决方案: 在Try方法中, 如果根据全局事务ID能查询出数据出来,说明在try方法之前执行了空回滚，此时就不能进行try方法。否则就正常执行try方法.</p>
<h4 id="异常处理流程图">异常处理流程图</h4>
<h5 id="try方法">Try方法</h5>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201211173603005.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201211173603005.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201211173603005.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201211173603005.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/image-20201211173603005.png"
        title="image-20201211173603005" /></strong></p>
<h5 id="comfirm方法">Comfirm方法</h5>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/Confirm%E6%96%B9%E6%B3%95%E9%80%BB%E8%BE%91.jpg"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/Confirm%E6%96%B9%E6%B3%95%E9%80%BB%E8%BE%91.jpg, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/Confirm%E6%96%B9%E6%B3%95%E9%80%BB%E8%BE%91.jpg 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/Confirm%E6%96%B9%E6%B3%95%E9%80%BB%E8%BE%91.jpg 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/Confirm%E6%96%B9%E6%B3%95%E9%80%BB%E8%BE%91.jpg"
        title="img" /></strong></p>
<h5 id="cancel方法">Cancel方法</h5>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/Cancel%E6%96%B9%E6%B3%95%E9%80%BB%E8%BE%91.jpg"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/Cancel%E6%96%B9%E6%B3%95%E9%80%BB%E8%BE%91.jpg, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/Cancel%E6%96%B9%E6%B3%95%E9%80%BB%E8%BE%91.jpg 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/Cancel%E6%96%B9%E6%B3%95%E9%80%BB%E8%BE%91.jpg 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/Cancel%E6%96%B9%E6%B3%95%E9%80%BB%E8%BE%91.jpg"
        title="img" /></p>
<h4 id="tcc模式代码实现">TCC模式代码实现</h4>
<p>分布式事务发起方只需要贴<code>@GlobalTransactional</code>注解即可</p>
<p>分支事务需要完成下面步骤:</p>
<p>在接口上贴上<code>@LocalTCC</code>和<code>@TwoPhaseBusinessAction</code>注解</p>
<h5 id="发起方-1">发起方</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@GlobalTransactional</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Transactional</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">refund</span><span class="o">(</span><span class="n">String</span> <span class="n">orderNo</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//1.通过orderInfo 查询订单信息 从mysql中查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">OrderInfo</span> <span class="n">orderInfo</span> <span class="o">=</span> <span class="n">orderInfoMapper</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">orderNo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="o">(</span><span class="n">orderInfo</span><span class="o">.</span><span class="na">getPayType</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">OrderInfo</span><span class="o">.</span><span class="na">PAYTYPE_INTERGRAL</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">refoundIntergral</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="n">OrderInfo</span><span class="o">.</span><span class="na">PAYTYPE_ONLINE</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * show 订单积分退货
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param orderInfo 订单信息
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">refoundIntergral</span><span class="o">(</span><span class="n">OrderInfo</span> <span class="n">orderInfo</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//1 增加退款日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">RefundLog</span> <span class="n">refundLog</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RefundLog</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">refundLog</span><span class="o">.</span><span class="na">setOutTradeNo</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">.</span><span class="na">getOrderNo</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">refundLog</span><span class="o">.</span><span class="na">setRefundAmount</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">.</span><span class="na">getIntergral</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">refundLog</span><span class="o">.</span><span class="na">setRefundReason</span><span class="o">(</span><span class="s">&#34;不想要了&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">refundLog</span><span class="o">.</span><span class="na">setRefundType</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">.</span><span class="na">getPayType</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">refundLog</span><span class="o">.</span><span class="na">setRefundTime</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">refundLogMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">refundLog</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//2 订单状态 1&gt;&gt;4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">orderInfoMapper</span><span class="o">.</span><span class="na">changeRefundStatus</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">.</span><span class="na">getOrderNo</span><span class="o">(),</span> <span class="n">OrderInfo</span><span class="o">.</span><span class="na">STATUS_REFUND</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//3 远程调用积分服务 加积分
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">OperateIntergralVo</span> <span class="n">vo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OperateIntergralVo</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">vo</span><span class="o">.</span><span class="na">setPk</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">.</span><span class="na">getOrderNo</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">vo</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">.</span><span class="na">getIntergral</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">vo</span><span class="o">.</span><span class="na">setInfo</span><span class="o">(</span><span class="s">&#34;积分退款&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">vo</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">orderInfo</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">stringResult</span> <span class="o">=</span> <span class="n">intergralFeign</span><span class="o">.</span><span class="na">remoteIntergralUnfundTry</span><span class="o">(</span><span class="n">vo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">stringResult</span><span class="o">)</span> <span class="o">||</span> <span class="n">stringResult</span><span class="o">.</span><span class="na">getCode</span><span class="o">()</span> <span class="o">==</span> <span class="n">500000</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="n">SeckillCodeMsg</span><span class="o">.</span><span class="na">INTERGRAL_SERVER_ERROR</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="分支方">分支方</h5>
<ul>
<li>
<p>接口</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@LocalTCC</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IUsableIntegralService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * show TCC事务
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param vo
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param context
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@TwoPhaseBusinessAction</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;remoteIntergralUnfundTry&#34;</span><span class="o">,</span> <span class="n">commitMethod</span> <span class="o">=</span> <span class="s">&#34;incrIntergralCommit&#34;</span><span class="o">,</span> <span class="n">rollbackMethod</span> <span class="o">=</span> <span class="s">&#34;incrIntergralRollback&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="nf">remoteIntergralUnfundTry</span><span class="o">(</span><span class="nd">@BusinessActionContextParameter</span><span class="o">(</span><span class="n">paramName</span> <span class="o">=</span> <span class="s">&#34;operateIntergralVo&#34;</span><span class="o">)</span> <span class="n">OperateIntergralVo</span> <span class="n">vo</span><span class="o">,</span> <span class="n">BusinessActionContext</span> <span class="n">context</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="nf">incrIntergralCommit</span><span class="o">(</span><span class="n">BusinessActionContext</span> <span class="n">context</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">String</span> <span class="nf">incrIntergralRollback</span><span class="o">(</span><span class="n">BusinessActionContext</span> <span class="n">context</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>实现类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Service</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UsableIntegralServiceImpl</span> <span class="kd">implements</span> <span class="n">IUsableIntegralService</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">UsableIntegralMapper</span> <span class="n">usableIntegralMapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AccountTransactionMapper</span> <span class="n">accountTransactionMapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Resource</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AccountLogMapper</span> <span class="n">accountLogMapper</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * TCC事务 退款
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">remoteIntergralUnfundTry</span><span class="o">(</span><span class="nd">@BusinessActionContextParameter</span><span class="o">(</span><span class="n">paramName</span> <span class="o">=</span> <span class="s">&#34;operateIntergralVo&#34;</span><span class="o">)</span> <span class="n">OperateIntergralVo</span> <span class="n">vo</span><span class="o">,</span> <span class="n">BusinessActionContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//1查询事务信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AccountTransaction</span> <span class="n">accountTransactionReturn</span> <span class="o">=</span> <span class="n">accountTransactionMapper</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getXid</span><span class="o">(),</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getBranchId</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//2判断是否有信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">accountTransactionReturn</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//有
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">switch</span> <span class="o">(</span><span class="n">accountTransactionReturn</span><span class="o">.</span><span class="na">getState</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//try 幂等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">case</span> <span class="n">AccountTransaction</span><span class="o">.</span><span class="na">STATE_TRY</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//confirm 抛异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">case</span> <span class="n">AccountTransaction</span><span class="o">.</span><span class="na">STATE_COMMIT</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="n">IntergralCodeMsg</span><span class="o">.</span><span class="na">OP_INTERGRAL_ERROR</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//cancel 防悬挂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">case</span> <span class="n">AccountTransaction</span><span class="o">.</span><span class="na">STATE_CANCEL</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//1添加事务日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">AccountTransaction</span> <span class="n">accountTransaction</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AccountTransaction</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">accountTransaction</span><span class="o">.</span><span class="na">setTxId</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getXid</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">accountTransaction</span><span class="o">.</span><span class="na">setActionId</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getBranchId</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">            <span class="n">accountTransaction</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">vo</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">accountTransaction</span><span class="o">.</span><span class="na">setGmtCreated</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">accountTransaction</span><span class="o">.</span><span class="na">setGmtModified</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">accountTransaction</span><span class="o">.</span><span class="na">setAmount</span><span class="o">(</span><span class="n">vo</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">accountTransaction</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">AccountLog</span><span class="o">.</span><span class="na">TYPE_INCR</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">accountTransaction</span><span class="o">.</span><span class="na">setState</span><span class="o">(</span><span class="n">AccountTransaction</span><span class="o">.</span><span class="na">STATE_TRY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">accountTransactionMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">accountTransaction</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//2判断执行结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">accountTransactionReturn</span> <span class="o">=</span> <span class="n">accountTransactionMapper</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getXid</span><span class="o">(),</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getBranchId</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//3如果为真
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">accountTransactionReturn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//正常逻辑 啥也不做
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span><span class="c1">//4如果为假
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="n">IntergralCodeMsg</span><span class="o">.</span><span class="na">OP_INTERGRAL_ERROR</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">incrIntergralCommit</span><span class="o">(</span><span class="n">BusinessActionContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//1查询事务信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AccountTransaction</span> <span class="n">accountTransactionReturn</span> <span class="o">=</span> <span class="n">accountTransactionMapper</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getXid</span><span class="o">(),</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getBranchId</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//2判断是否有信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">accountTransactionReturn</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//有
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">switch</span> <span class="o">(</span><span class="n">accountTransactionReturn</span><span class="o">.</span><span class="na">getState</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//try 正常逻辑 加钱
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">case</span> <span class="n">AccountTransaction</span><span class="o">.</span><span class="na">STATE_TRY</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">String</span> <span class="n">operateIntergralVoToString</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getActionContext</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;operateIntergralVo&#34;</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">                    <span class="n">OperateIntergralVo</span> <span class="n">operateIntergralVo</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">operateIntergralVoToString</span><span class="o">,</span> <span class="n">OperateIntergralVo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">this</span><span class="o">.</span><span class="na">remoteIntergralUnfund</span><span class="o">(</span><span class="n">operateIntergralVo</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">//修改事务状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">accountTransactionMapper</span><span class="o">.</span><span class="na">updateAccountTransactionState</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                            <span class="n">context</span><span class="o">.</span><span class="na">getXid</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">                            <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getBranchId</span><span class="o">()),</span>
</span></span><span class="line"><span class="cl">                            <span class="n">AccountTransaction</span><span class="o">.</span><span class="na">STATE_COMMIT</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">AccountTransaction</span><span class="o">.</span><span class="na">STATE_TRY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//confirm 幂等
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">case</span> <span class="n">AccountTransaction</span><span class="o">.</span><span class="na">STATE_COMMIT</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//cancel 异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">case</span> <span class="n">AccountTransaction</span><span class="o">.</span><span class="na">STATE_CANCEL</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="n">IntergralCodeMsg</span><span class="o">.</span><span class="na">OP_INTERGRAL_ERROR</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//没有
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="n">IntergralCodeMsg</span><span class="o">.</span><span class="na">OP_INTERGRAL_ERROR</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">incrIntergralRollback</span><span class="o">(</span><span class="n">BusinessActionContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">operateIntergralVoToString</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getActionContext</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;operateIntergralVo&#34;</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">OperateIntergralVo</span> <span class="n">operateIntergralVo</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">operateIntergralVoToString</span><span class="o">,</span> <span class="n">OperateIntergralVo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//1查询事务信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AccountTransaction</span> <span class="n">accountTransactionReturn</span> <span class="o">=</span> <span class="n">accountTransactionMapper</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getXid</span><span class="o">(),</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getBranchId</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//2判断是否有信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">(!</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="n">accountTransactionReturn</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//有
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">switch</span> <span class="o">(</span><span class="n">accountTransactionReturn</span><span class="o">.</span><span class="na">getState</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//try 正常逻辑 修改状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">case</span> <span class="n">AccountTransaction</span><span class="o">.</span><span class="na">STATE_TRY</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">//修改事务状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">accountTransactionMapper</span><span class="o">.</span><span class="na">updateAccountTransactionState</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                            <span class="n">context</span><span class="o">.</span><span class="na">getXid</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">                            <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getBranchId</span><span class="o">()),</span>
</span></span><span class="line"><span class="cl">                            <span class="n">AccountTransaction</span><span class="o">.</span><span class="na">STATE_CANCEL</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">AccountTransaction</span><span class="o">.</span><span class="na">STATE_TRY</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//confirm 抛异常
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">case</span> <span class="n">AccountTransaction</span><span class="o">.</span><span class="na">STATE_COMMIT</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="o">(</span><span class="n">IntergralCodeMsg</span><span class="o">.</span><span class="na">OP_INTERGRAL_ERROR</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">//cancel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">case</span> <span class="n">AccountTransaction</span><span class="o">.</span><span class="na">STATE_CANCEL</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//没有 添加事务日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">AccountTransaction</span> <span class="n">accountTransaction</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AccountTransaction</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">accountTransaction</span><span class="o">.</span><span class="na">setTxId</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getXid</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">accountTransaction</span><span class="o">.</span><span class="na">setActionId</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getBranchId</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">            <span class="n">accountTransaction</span><span class="o">.</span><span class="na">setUserId</span><span class="o">(</span><span class="n">operateIntergralVo</span><span class="o">.</span><span class="na">getUserId</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">accountTransaction</span><span class="o">.</span><span class="na">setGmtCreated</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">accountTransaction</span><span class="o">.</span><span class="na">setGmtModified</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">accountTransaction</span><span class="o">.</span><span class="na">setAmount</span><span class="o">(</span><span class="n">operateIntergralVo</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">accountTransaction</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">AccountLog</span><span class="o">.</span><span class="na">TYPE_INCR</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">accountTransaction</span><span class="o">.</span><span class="na">setState</span><span class="o">(</span><span class="n">AccountTransaction</span><span class="o">.</span><span class="na">STATE_CANCEL</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">accountTransactionMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">accountTransaction</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="其他">其他</h2>
<h3 id="单服务集群idea">单服务集群IDEA</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">-Dserver.port=8001
</span></span></code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2021-09-08%2021.13.28.png"
        data-srcset="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2021-09-08%2021.13.28.png, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2021-09-08%2021.13.28.png 1.5x, https://images-jsh.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2021-09-08%2021.13.28.png 2x"
        data-sizes="auto"
        alt="https://images-jsh.oss-cn-beijing.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2021-09-08%2021.13.28.png"
        title="截屏2021-09-08 21.13.28" /></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2021-09-04</span>
            </div><div class="post-info-license">
                <span><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/springcloud%E5%B8%B8%E7%94%A8/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a>,&nbsp;<a href="/tags/%E6%A1%86%E6%9E%B6/">框架</a>,&nbsp;<a href="/tags/%E6%95%B4%E7%90%86/">整理</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/gitlab%E7%A7%81%E6%9C%8D%E6%90%AD%E5%BB%BA/" class="prev" rel="prev" title="gitlab私服搭建"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>gitlab私服搭建</a>
            <a href="/rocketmq/" class="next" rel="next" title="RocketMQ">RocketMQ<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2018 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/coderabbit214" target="_blank">coderabbit</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/contrib/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
